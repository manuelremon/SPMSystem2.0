import{b as ga,o as pa,u as fa,r as o,d as ha,j as e,k as ba,B as _,L as va,X as Ie,h as _a,p as ja}from"./index-C0KzVn15.js";import{s as K,m as Re}from"./spm-DzdMHgGJ.js";import{f as j,a as Na}from"./formatters-B3FH-qkk.js";import{r as Sa}from"./sectores-D5jxTgHT.js";import{I as Pe}from"./Input-CFrh4iUm.js";import{C as se,c as te,a as ya,b as wa}from"./Card-CZhI6Cu1.js";import{A as Te}from"./Alert-JliWwR_S.js";import{P as Le}from"./PageHeader-CTTYnUT3.js";import{M as Oe}from"./Modal-D1uVOYl2.js";import{C as Be}from"./ConfirmModal-DKtA_mI4.js";import{T as Ca}from"./Skeleton-wCrGMhoU.js";import{B as Ue}from"./Badge-d4rYTU1N.js";import{S as re}from"./ScrollReveal-CaWzGJkt.js";import{L as oe}from"./loader-2-D1Kak4Iw.js";import{C as ze}from"./check-BNm1Rmot.js";import{T as ka}from"./trash-2-i7v8vBz5.js";import"./info-A2zy8862.js";import"./alert-circle-mNlb3XAQ.js";import"./x-circle-BDEZXh-7.js";import"./check-circle-BLjEl7wu.js";const Fe=250,Ve=500,Da=3e3;function He(a,m){const[u,i]=o.useState(a);return o.useEffect(()=>{const b=setTimeout(()=>i(a),m);return()=>clearTimeout(b)},[a,m]),u}function Qa(){var ve,_e,je,Ne,Se,ye,we,Ce,ke,De,Me,Ee,Ae,$e;const{t:a}=ga(),{id:m}=pa(),u=fa(),[i,b]=o.useState(null),[c,N]=o.useState([]),[Ke,le]=o.useState(!0),[ne,f]=o.useState(""),[O,h]=o.useState(""),[B,k]=o.useState(""),[U,D]=o.useState(""),z=He(B,Fe),F=He(U,Fe),[x,A]=o.useState([]),[M,ie]=o.useState(!1),[$,p]=o.useState(!1),[l,E]=o.useState(null),[Xe,ce]=o.useState(!1),[r,S]=o.useState(null),[V,de]=o.useState(!1),[me,Je]=o.useState({}),[X,H]=o.useState(!1),[ue,J]=o.useState(!1),[Qe,Q]=o.useState(!1),[Ye,Y]=o.useState(!1),[I,xe]=o.useState(!1),[q,ge]=o.useState(!1),W=o.useRef(null),R=o.useRef(null),[P,v]=o.useState(-1),[Z,We]=o.useState({top:0,left:0,width:0}),[pe,fe]=o.useState([]),Ze=o.useMemo(()=>JSON.stringify(c)!==JSON.stringify(pe),[c,pe]),[y,T]=o.useState({open:!1,codigo:null,comment:""}),[G,ea]=o.useState(null),ee=o.useMemo(()=>(i==null?void 0:i.centro)||localStorage.getItem("lastCentro")||"",[i]),ae=o.useMemo(()=>(i==null?void 0:i.almacen_virtual)||(i==null?void 0:i.almacen)||localStorage.getItem("lastAlmacen")||"",[i]);o.useEffect(()=>{m&&(le(!0),K.obtener(m).then(s=>{const t=s.data.solicitud||s.data;b(t);const n=Array.isArray(t==null?void 0:t.items)?t.items:[];N(n),fe(n),t!=null&&t.centro&&(t!=null&&t.sector)&&ha.get("/planificador/presupuesto",{params:{centro:t.centro,sector:t.sector}}).then(d=>ea(d.data)).catch(()=>{})}).catch(s=>{var t,n,d;return f(((d=(n=(t=s.response)==null?void 0:t.data)==null?void 0:n.error)==null?void 0:d.message)||s.message)}).finally(()=>le(!1)))},[m]),o.useEffect(()=>{const s=t=>{W.current&&!W.current.contains(t.target)&&R.current&&!R.current.contains(t.target)&&p(!1)};if($)return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[$]),o.useEffect(()=>{if($&&R.current){const s=R.current.getBoundingClientRect();We({top:s.bottom+window.scrollY+4,left:s.left+window.scrollX,width:s.width})}},[$,x]),o.useEffect(()=>{if(O){const s=setTimeout(()=>h(""),Da);return()=>clearTimeout(s)}},[O]),o.useEffect(()=>{if(!(z.trim()!==""||F.trim()!=="")){A([]),p(!1);return}ie(!0),v(-1),Re.buscar({codigo:z.trim(),descripcion:F.trim(),limit:Ve}).then(t=>{A((t.data||[]).slice(0,Ve)),p(!0)}).catch(t=>{console.error("search materiales",t),A([]),p(!1)}).finally(()=>ie(!1))},[z,F]);const w=o.useCallback(async(s,t=!1)=>{de(!0);try{const d=(await Re.detalle(s,{centro:ee,almacen:ae})).data||{};return Je(L=>({...L,[s]:d})),t&&(S(d),ce(!0),H(!0)),d}catch(n){return console.error("detalle material",n),t&&S(null),null}finally{de(!1)}},[ee,ae]),he=o.useCallback(s=>{if(x.length)if(s.key==="ArrowDown")s.preventDefault(),p(!0),v(t=>t<x.length-1?t+1:0);else if(s.key==="ArrowUp")s.preventDefault(),p(!0),v(t=>t>0?t-1:x.length-1);else if(s.key==="Enter")if(s.preventDefault(),P>=0&&x[P]){const t=x[P];E(t),p(!1),v(-1),k(t.codigo),D(t.descripcion),S(null),J(!1),w(t.codigo,!1).then(n=>{n&&(S(n),H(!0))})}else x.length>0&&p(!0);else s.key==="Escape"&&(p(!1),v(-1))},[x,P,w]),aa=o.useCallback(async s=>{E(s),p(!1),v(-1),k(""),D(""),A([]),S(null),J(!1);const t=await w(s.codigo,!1);t&&(S(t),H(!0))},[w]),sa=o.useCallback(async()=>{if(!l)return;me[l.codigo]||await w(l.codigo,!1);const t=c.find(n=>n.codigo===l.codigo)?c.map(n=>n.codigo===l.codigo?{...n,cantidad:(n.cantidad||1)+1}:n):[...c,{codigo:l.codigo,descripcion:l.descripcion,descripcion_larga:l.descripcion_larga,unidad:l.unidad||"UNI",cantidad:1,precio_unitario:l.precio_usd||0}];N(t),h(a("materials_added","Material agregado al listado.")),E(null),H(!1),S(null)},[l,me,c,w,a]),ta=o.useCallback((s,t)=>{const n=Number(t);Number.isNaN(n)||n<1||N(d=>d.map(L=>L.codigo===s?{...L,cantidad:n}:L))},[]),ra=o.useCallback(s=>{N(t=>t.filter(n=>n.codigo!==s))},[]),oa=o.useCallback(()=>{k(""),D(""),A([]),p(!1),v(-1),E(null)},[]),la=o.useCallback(s=>{const t=c.find(n=>n.codigo===s);T({open:!0,codigo:s,comment:(t==null?void 0:t.comentario)||""})},[c]),na=o.useCallback(()=>{N(s=>s.map(t=>t.codigo===y.codigo?{...t,comentario:y.comment}:t)),T({open:!1,codigo:null,comment:""})},[y]),C=o.useMemo(()=>c.reduce((s,t)=>s+(t.cantidad||0)*(t.precio_unitario||0),0),[c]),ia=o.useCallback(async()=>{var s,t,n;h(""),f(""),ge(!0);try{const d=await K.guardarBorrador(m,c,C);b(d.data.solicitud||d.data),fe([...c]),h(a("materials_draft_saved","Borrador guardado."))}catch(d){f(((n=(t=(s=d.response)==null?void 0:s.data)==null?void 0:t.error)==null?void 0:n.message)||d.message)}finally{ge(!1)}},[m,c,C,a]),ca=o.useCallback(()=>{if(f(""),!c.length){f(a("materials_add_at_least_one","Agrega al menos un ítem"));return}Y(!0)},[c.length,a]),da=o.useCallback(async()=>{var s,t,n;Y(!1),h(""),f(""),xe(!0);try{const d=await K.finalizar(m,{...i||{},items:c,total_monto:C});b(d.data.solicitud||d.data),h(a("materials_submitted","Solicitud enviada para aprobación. Redirigiendo...")),setTimeout(()=>{u("/mis-solicitudes")},1500)}catch(d){f(((n=(t=(s=d.response)==null?void 0:s.data)==null?void 0:t.error)==null?void 0:n.message)||d.message)}finally{xe(!1)}},[m,c,i,C,a,u]),ma=o.useCallback(()=>{Q(!0)},[]),ua=o.useCallback(async()=>{Q(!1),f("");try{await K.eliminar(m),N([]),E(null),k(""),D(""),h(a("materials_cancelar_success","Solicitud cancelada. Redirigiendo...")),setTimeout(()=>u("/mis-solicitudes"),1500)}catch{N([]),E(null),k(""),D(""),h(a("materials_cancelar_local","Datos locales limpiados."))}},[m,a,u]),xa=G&&C>(G.saldo_usd??0),be=o.useMemo(()=>[...c].sort((s,t)=>String(t.codigo).localeCompare(String(s.codigo))),[c]);return Ke?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Le,{title:a("materials_title","Agregar Materiales")}),e.jsx(se,{children:e.jsx(te,{className:"pt-6",children:e.jsx(Ca,{rows:5,columns:6})})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(re,{children:e.jsx(Le,{title:a("materials_title","Agregar Materiales"),subtitle:Ze?e.jsx(Ue,{variant:"warning",children:a("common_sin_guardar","Sin guardar")}):null,actions:e.jsx(_,{as:va,to:"/mis-solicitudes",variant:"ghost","aria-label":a("common_volver_mis_solicitudes","Volver a Mis Solicitudes"),children:a("common_volver","Volver")})})}),ne&&e.jsx(Te,{variant:"danger",onDismiss:()=>f(""),children:ne}),O&&e.jsx(Te,{variant:"success",onDismiss:()=>h(""),children:O}),e.jsx(re,{delay:100,children:e.jsx(se,{hover:!1,children:e.jsx(te,{className:"pt-6 space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{ref:R,className:"space-y-3",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--fg-muted)] uppercase tracking-wide",children:a("materials_buscar","Buscar material")}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("div",{className:"relative w-full sm:w-36 shrink-0",children:e.jsx(Pe,{id:"searchCodigo",value:B,onChange:s=>k(s.target.value),onKeyDown:he,placeholder:a("materials_codigo_sap","Código SAP"),className:"font-mono","aria-label":a("materials_codigo_sap","Código SAP")})}),e.jsx("div",{className:"relative flex-1 sm:max-w-sm",children:e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{id:"searchDesc",value:U,onChange:s=>D(s.target.value),onKeyDown:he,placeholder:a("materials_buscar_desc","Buscar por descripción..."),"aria-label":a("materials_descripcion","Descripción")}),e.jsxs("div",{className:"absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1.5",children:[M&&e.jsx(oe,{className:"h-4 w-4 animate-spin text-[var(--fg-muted)]"}),!M&&x.length>0&&e.jsx("span",{className:"text-xs text-[var(--fg-muted)] bg-[var(--bg-soft)] px-1.5 py-0.5 rounded",children:x.length}),(B||U)&&e.jsx("button",{type:"button",onClick:oa,className:"p-0.5 hover:bg-[var(--bg-elevated)] rounded transition-colors","aria-label":a("materials_limpiar_busqueda","Limpiar búsqueda"),children:e.jsx(Ie,{className:"h-4 w-4 text-[var(--fg-muted)]"})})]})]})})]}),(B||U)&&!M&&x.length>0&&e.jsxs("p",{className:"text-xs text-[var(--fg-muted)]",children:[x.length," ",x.length===1?a("common_resultado","resultado"):a("common_resultados","resultados"),e.jsxs("span",{className:"opacity-60",children:[" — ",a("materials_selecciona_uno","selecciona uno")]})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{className:"text-xs font-medium text-[var(--fg-muted)] uppercase tracking-wide mb-3",children:a("materials_selected","Material seleccionado")}),l?e.jsxs("div",{className:"p-3 bg-[var(--bg-soft)] border border-[var(--primary)]/30 rounded-lg flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[X&&e.jsx(ze,{className:"h-4 w-4 text-[var(--success)]"}),e.jsx("span",{className:"font-mono text-sm text-[var(--primary)] font-medium",children:l.codigo})]}),e.jsx("p",{className:"text-sm text-[var(--fg-strong)] font-medium mb-1 line-clamp-2",children:l.descripcion}),l.precio_usd>0&&e.jsxs("p",{className:"text-sm text-[var(--fg-muted)]",children:[a("materials_precio","Precio"),": ",e.jsx("span",{className:"font-mono font-medium",children:j(l.precio_usd)})]}),!X&&e.jsxs("p",{className:"text-xs text-[var(--warning)] mt-2 flex items-center gap-1",children:[e.jsx("span",{className:"inline-block w-1.5 h-1.5 bg-[var(--warning)] rounded-full"}),a("materials_view_detail_first","Ver detalles antes de agregar")]}),e.jsxs("div",{className:"flex items-center gap-2 mt-3 pt-3 border-t border-[var(--border)]",children:[e.jsx(_,{size:"sm",variant:"secondary",className:"flex-1",onClick:async()=>{l&&await w(l.codigo,!0)},disabled:V,children:V?e.jsx(oe,{className:"h-4 w-4 animate-spin"}):a("materials_mas_detalles","Ver detalles")}),e.jsx(_,{size:"sm",className:"flex-1",onClick:sa,disabled:!X,children:a("materials_agregar","Agregar")})]})]}):e.jsx("div",{className:"p-4 border border-dashed border-[var(--border)] rounded-lg flex-1 flex items-center justify-center",children:e.jsx("p",{className:"text-sm text-[var(--fg-muted)] text-center",children:a("materials_busca_selecciona","Busca y selecciona un material")})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-[var(--fg-muted)] uppercase tracking-wide mb-3",children:a("materials_contexto","Contexto")}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a("common_solicitud","Solicitud")}),e.jsxs("p",{className:"font-semibold text-[var(--fg-strong)]",children:["#",m]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a("common_centro","Centro")}),e.jsx("p",{className:"font-semibold text-[var(--fg-strong)]",children:(i==null?void 0:i.centro)||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a("common_sector","Sector")}),e.jsx("p",{className:"font-semibold text-[var(--fg-strong)]",children:Sa(i)||"—"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a("common_almacen","Almacén")}),e.jsx("p",{className:"font-semibold text-[var(--fg-strong)]",children:(i==null?void 0:i.almacen_virtual)||"—"})]}),e.jsx("div",{className:"col-span-2 pt-2 mt-2 border-t border-[var(--border)]",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a("common_total","Total")}),e.jsx("p",{className:"font-bold text-lg text-[var(--fg-strong)] font-mono",children:j(C)})]}),G&&e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a("materials_saldo_disponible","Saldo disponible")}),e.jsx("p",{className:`font-semibold font-mono ${xa?"text-[var(--danger)]":"text-[var(--success)]"}`,children:j(G.saldo_usd||0)})]})]})})]})]})]})})})}),e.jsx(re,{delay:200,children:e.jsxs(se,{hover:!1,children:[e.jsx(ya,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(wa,{children:a("materials_resumen","Resumen de Materiales")}),c.length>0&&e.jsxs(Ue,{variant:"primary",children:[c.length," ",c.length===1?a("common_item","item"):a("common_items","items")]})]})}),e.jsxs(te,{children:[e.jsx("div",{className:"overflow-x-auto border border-[var(--border)] rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",role:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-[var(--border)] bg-[var(--bg-soft)]",children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:a("materials_col_codigo","Código")}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:a("materials_col_descripcion","Descripción")}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:a("materials_col_unidad","Unidad")}),e.jsx("th",{className:"px-2 py-3 text-center text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)] w-20",children:a("materials_col_cantidad","Cant.")}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:a("materials_col_precio","Precio USD")}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:a("materials_col_subtotal","Subtotal")}),e.jsx("th",{className:"px-2 py-3 text-center text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)] w-12",children:a("materials_col_nota","Nota")}),e.jsx("th",{className:"px-2 py-3 text-center text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)] w-12"})]})}),e.jsxs("tbody",{children:[be.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-8 text-center text-[var(--fg-muted)]",colSpan:8,children:a("materials_sin_materiales","Sin materiales agregados")})}),be.map((s,t)=>{const n=(s.cantidad||0)*(s.precio_unitario||0);return e.jsxs("tr",{className:`
                        border-b border-[var(--border)] transition-colors
                        ${t%2===0?"bg-transparent":"bg-[var(--bg-soft)]/30"}
                        hover:bg-[var(--bg-elevated)]
                      `,children:[e.jsx("td",{className:"px-4 py-3 font-mono font-semibold text-[var(--fg-strong)]",children:s.codigo}),e.jsx("td",{className:"px-4 py-3 text-[var(--fg)]",children:s.descripcion}),e.jsx("td",{className:"px-4 py-3 text-center text-[var(--fg-muted)]",children:s.unidad||"-"}),e.jsx("td",{className:"px-2 py-3",children:e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("input",{type:"number",min:"1",step:"1",value:s.cantidad||0,onChange:d=>ta(s.codigo,d.target.value),className:"w-16 text-center px-2 py-1.5 rounded-md border-2 border-[var(--accent)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--accent)]/50 focus:outline-none","aria-label":a("materials_cantidad_label","Cantidad del material")})})}),e.jsx("td",{className:"px-4 py-3 text-right font-mono text-[var(--fg)]",children:j(s.precio_unitario||0)}),e.jsx("td",{className:"px-4 py-3 text-right font-mono font-semibold text-[var(--fg-strong)]",children:j(n)}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("button",{type:"button",onClick:()=>la(s.codigo),className:`
                            p-2 rounded-lg transition-colors
                            ${s.comentario?"text-[var(--primary)] bg-[var(--primary-muted)]":"text-[var(--fg-muted)] hover:text-[var(--fg)] hover:bg-[var(--bg-elevated)]"}
                          `,title:s.comentario||a("materials_agregar_nota","Agregar nota"),"aria-label":`${a("materials_nota_label","Nota para")} ${s.codigo}`,children:e.jsx(_a,{className:"w-4 h-4"})})}),e.jsx("td",{className:"px-2 py-3 text-center",children:e.jsx("button",{type:"button",onClick:()=>ra(s.codigo),className:"p-2 rounded-lg text-[var(--danger)] hover:bg-[var(--danger)]/10 transition-colors",title:a("materials_eliminar","Eliminar"),"aria-label":`${a("materials_eliminar","Eliminar")} ${s.codigo}`,children:e.jsx(ka,{className:"w-4 h-4"})})})]},s.codigo)})]})]})}),e.jsxs("div",{className:"flex flex-wrap gap-3 justify-end mt-6 pt-4 border-t border-[var(--border)]",children:[e.jsx(_,{variant:"ghost",onClick:ma,disabled:I||q,"aria-label":a("materials_cancelar_solicitud","Cancelar Solicitud"),children:a("materials_cancelar_solicitud","Cancelar Solicitud")}),e.jsx(_,{variant:"secondary",onClick:ia,disabled:c.length===0||q||I,"aria-label":a("materials_guardar_borrador","Guardar como borrador"),children:q?a("materials_guardando","Guardando..."):a("materials_guardar_borrador","Guardar como borrador")}),e.jsx(_,{onClick:ca,disabled:c.length===0||I||q,"aria-label":a("materials_enviar","Enviar Solicitud"),children:I?a("materials_enviando","Enviando..."):a("materials_enviar","Enviar Solicitud")})]})]})]})}),e.jsx(Oe,{isOpen:Xe,onClose:()=>ce(!1),title:l?`${l.codigo} — ${l.descripcion}`:a("materials_detalle","Detalle del Material"),size:"xl",children:l&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-[var(--bg-soft)] border border-[var(--border)] rounded-lg",children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-[var(--fg-muted)] mb-2",children:a("materials_desc_larga","Descripción larga")}),e.jsx("p",{className:"text-[var(--fg)]",children:l.descripcion_larga||"N/D"})]}),e.jsxs("div",{className:"p-4 bg-[var(--bg-soft)] border border-[var(--border)] rounded-lg space-y-2",children:[e.jsx(g,{label:a("materials_unidad","Unidad"),value:l.unidad||"N/D"}),e.jsx(g,{label:a("materials_precio_usd","Precio USD"),value:j(l.precio_usd||0)}),e.jsx(g,{label:a("materials_centro","Centro consultado"),value:(r==null?void 0:r.centro_consultado)||ee||"N/D"}),e.jsx(g,{label:a("materials_almacen","Almacén consultado"),value:(r==null?void 0:r.almacen_consultado)||ae||"N/D"}),e.jsx(g,{label:a("materials_stock","Stock (centro/almacén)"),value:V?"...":(r==null?void 0:r.stock_total)??"N/D"}),e.jsx(g,{label:a("materials_pedidos","Pedidos en curso"),value:V?"...":(r==null?void 0:r.pedidos_en_curso)??"N/D"}),e.jsx(g,{label:a("materials_spm_en_curso","Solicitudes SPM en curso"),value:"N/D"}),e.jsxs("div",{className:"pt-2",children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-[var(--fg-muted)] mb-1",children:a("materials_stock_detalle","Stock detallado (centro)")}),e.jsx(qe,{rows:(r==null?void 0:r.stock_detalle)||[]}),(((ve=r==null?void 0:r.stock_detalle_full)==null?void 0:ve.length)||0)>(((_e=r==null?void 0:r.stock_detalle)==null?void 0:_e.length)||0)&&e.jsx("button",{type:"button",className:"text-xs font-semibold text-[var(--accent)] hover:underline mt-2",onClick:()=>J(s=>!s),children:ue?a("materials_ocultar_stock","Ocultar stock interno completo"):a("materials_ver_stock","Ver stock interno completo (+)")}),ue&&e.jsx(qe,{rows:(r==null?void 0:r.stock_detalle_full)||[],compact:!0})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-[var(--warning-bg)] border border-[var(--warning-border)] rounded-lg space-y-2",children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-[var(--fg-muted)] mb-2",children:a("materials_mrp","MRP / Reposición automática")}),e.jsx(g,{label:a("materials_planificado_mrp","Planificado MRP"),value:(je=r==null?void 0:r.mrp)!=null&&je.planificado_mrp?"Sí":"No"}),e.jsx(g,{label:a("materials_sector","Sector"),value:((Ne=r==null?void 0:r.mrp)==null?void 0:Ne.sector)||"N/D"}),e.jsx(g,{label:a("materials_stock_seguridad","Stock seguridad"),value:((Se=r==null?void 0:r.mrp)==null?void 0:Se.stock_seguridad)??"N/D"}),e.jsx(g,{label:a("materials_punto_pedido","Punto pedido"),value:((ye=r==null?void 0:r.mrp)==null?void 0:ye.punto_pedido)??"N/D"}),e.jsx(g,{label:a("materials_stock_maximo","Stock máximo"),value:((we=r==null?void 0:r.mrp)==null?void 0:we.stock_maximo)??"N/D"})]}),e.jsxs("div",{className:"p-4 bg-[var(--info-bg)] border border-[var(--info-border)] rounded-lg space-y-2",children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-[var(--fg-muted)] mb-2",children:a("materials_consumo","Consumo histórico")}),e.jsx(g,{label:a("materials_total_consumo","Total consumo"),value:(ke=(Ce=r==null?void 0:r.consumo)==null?void 0:Ce.total)!=null&&ke.toFixed?r.consumo.total.toFixed(0):"N/D"}),e.jsx(g,{label:a("materials_promedio_anual","Promedio anual"),value:(Me=(De=r==null?void 0:r.consumo)==null?void 0:De.promedio_anual)!=null&&Me.toFixed?r.consumo.promedio_anual.toFixed(0):"N/D"}),e.jsx(g,{label:a("materials_rango_anios","Rango años"),value:(Ee=r==null?void 0:r.consumo)!=null&&Ee.anio_desde?`${r.consumo.anio_desde} - ${r.consumo.anio_hasta}`:"N/D"}),e.jsxs("div",{className:"pt-2",children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-[var(--fg-muted)] mb-1",children:a("materials_ultimos_consumos","Últimos consumos")}),(((Ae=r==null?void 0:r.consumo)==null?void 0:Ae.registros)||[]).length===0?e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:a("materials_sin_registros","Sin registros")}):e.jsx("div",{className:"space-y-1",children:((($e=r==null?void 0:r.consumo)==null?void 0:$e.registros)||[]).map((s,t)=>e.jsxs("div",{className:"flex justify-between text-xs text-[var(--fg)]",children:[e.jsx("span",{children:s.fecha}),e.jsx("span",{className:"font-semibold font-mono",children:s.cantidad})]},t))})]})]})]})]})}),e.jsx(Be,{isOpen:Qe,onClose:()=>Q(!1),onConfirm:ua,title:a("materials_cancelar_titulo","Cancelar Solicitud"),description:a("materials_cancelar_confirm","Se borrarán todos los datos ingresados. ¿Continuar?"),confirmText:a("common_confirmar","Confirmar"),cancelText:a("common_cancelar","Cancelar"),variant:"warning"}),e.jsx(Be,{isOpen:Ye,onClose:()=>Y(!1),onConfirm:da,title:a("materials_enviar_titulo","Enviar Solicitud"),description:a("materials_enviar_confirm",`¿Confirmas el envío de la solicitud con ${c.length} material(es) por un total de ${j(C)}?`),confirmText:a("materials_enviar_btn","Sí, enviar solicitud"),cancelText:a("common_cancelar","Cancelar"),variant:"info",loading:I}),e.jsx(Oe,{isOpen:y.open,onClose:()=>T({open:!1,codigo:null,comment:""}),title:a("materials_nota_titulo","Nota para el material"),size:"md",children:e.jsxs("div",{className:"space-y-4",children:[y.codigo&&e.jsxs("p",{className:"text-sm text-[var(--fg-muted)]",children:[a("materials_nota_para","Material:")," ",e.jsx("span",{className:"font-mono font-semibold text-[var(--fg-strong)]",children:y.codigo})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{htmlFor:"commentInput",className:"text-xs uppercase font-semibold tracking-wide text-[var(--fg-muted)]",children:a("materials_nota_label_input","Comentario / Nota")}),e.jsx("textarea",{id:"commentInput",value:y.comment,onChange:s=>T(t=>({...t,comment:s.target.value})),className:"w-full px-3 py-2.5 rounded-[var(--radius-md)] border border-[var(--input-border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] placeholder:text-[var(--fg-subtle)] focus:ring-2 focus:ring-[var(--input-focus)] focus:border-[var(--primary)] outline-none transition-all resize-none",rows:4,placeholder:a("materials_nota_placeholder","Escribe una nota o comentario para este material..."),"aria-label":a("materials_nota_label_input","Comentario / Nota")})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(_,{variant:"ghost",onClick:()=>T({open:!1,codigo:null,comment:""}),children:a("common_cancelar","Cancelar")}),e.jsx(_,{onClick:na,children:a("materials_nota_guardar","Guardar nota")})]})]})}),$&&ba.createPortal(e.jsxs("div",{ref:W,className:"fixed bg-[var(--card)] border border-[var(--border)] rounded-lg shadow-2xl overflow-hidden",style:{top:Z.top,left:Z.left,width:Z.width,zIndex:9999,maxHeight:"320px"},role:"listbox","aria-label":a("materials_resultados","Resultados de búsqueda"),children:[e.jsxs("div",{className:"sticky top-0 bg-[var(--bg-elevated)] border-b border-[var(--border)] px-4 py-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium text-[var(--fg-muted)]",children:M?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-3 w-3 animate-spin"}),a("common_buscando","Buscando...")]}):`${x.length} ${x.length!==1?a("common_resultados","resultados"):a("common_resultado","resultado")}`}),e.jsx("button",{type:"button",onClick:()=>p(!1),className:"p-1 hover:bg-[var(--bg-soft)] rounded transition-colors","aria-label":a("common_cerrar","Cerrar"),children:e.jsx(Ie,{className:"h-3.5 w-3.5 text-[var(--fg-muted)]"})})]}),e.jsxs("div",{className:"overflow-y-auto",style:{maxHeight:"280px"},children:[!M&&x.length===0&&e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(ja,{className:"h-8 w-8 text-[var(--fg-muted)]/40 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:a("materials_sin_resultados","No se encontraron materiales")})]}),!M&&x.map((s,t)=>e.jsxs("button",{role:"option","aria-selected":(l==null?void 0:l.codigo)===s.codigo,className:`
                    w-full text-left px-4 py-3 flex items-center gap-3
                    border-b border-[var(--border)]/50 last:border-b-0
                    transition-all duration-100
                    ${(l==null?void 0:l.codigo)===s.codigo?"bg-[var(--primary)]/10 border-l-2 border-l-[var(--primary)]":"border-l-2 border-l-transparent"}
                    ${P===t?"bg-[var(--bg-elevated)]":"hover:bg-[var(--bg-soft)]"}
                  `,onClick:()=>aa(s),onMouseEnter:()=>v(t),type:"button",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-sm font-semibold text-[var(--primary)]",children:Ge(s.codigo,z)}),(l==null?void 0:l.codigo)===s.codigo&&e.jsx(ze,{className:"h-3.5 w-3.5 text-[var(--primary)]"})]}),e.jsx("p",{className:"text-sm text-[var(--fg)] truncate mt-0.5",children:Ge(s.descripcion,F)})]}),e.jsx("span",{className:"text-xs font-mono text-[var(--fg-muted)] bg-[var(--bg-soft)] px-2 py-1 rounded shrink-0",children:j(s.precio_usd||0)})]},s.codigo))]})]}),document.body)]})}function g({label:a,value:m}){return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-[var(--fg-muted)]",children:a}),e.jsx("span",{className:"font-semibold text-[var(--fg-strong)]",children:m})]})}function qe({rows:a=[],compact:m=!1}){return!a||a.length===0?e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:"Sin stock registrado"}):e.jsx("div",{className:`space-y-1 ${m?"mt-1":"mt-2"}`,children:a.map((u,i)=>e.jsxs("div",{className:"text-xs text-[var(--fg)] border border-dashed border-[var(--border)] px-2 py-1 rounded",children:["Centro ",u.centro||"N/D"," / Almacén ",Na(u.almacen_consultado||u.almacen),u.lote?` / Lote ${u.lote}`:""," / Stock ",u.stock??u.cantidad??"N/D"]},i))})}function Ge(a,m){if(!m)return a;const u=new RegExp(`(${Ma(m)})`,"gi");return String(a).split(u).map((i,b)=>u.test(i)?e.jsx("mark",{className:"bg-[var(--warning)] text-[var(--on-primary)] rounded px-0.5",children:i},b):e.jsx("span",{children:i},b))}function Ma(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}export{Qa as default};
