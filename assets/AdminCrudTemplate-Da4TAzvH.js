import{c as ae,b as re,r as t,j as a,B as b,S as se,X as te}from"./index-DSailSuQ.js";import{a as A}from"./spm-BFWwVGn1.js";import{C as ne,a as le,b as oe,d as ce,c as ie}from"./Card-DuU2GO_U.js";import{I as de}from"./Input-C0tGZyv5.js";import{S as me}from"./Select-Wd5nfjCs.js";import{S as ue}from"./SearchInput-DXryunDL.js";import{D as pe}from"./DataTable-Br9CZ1Zt.js";import{A as F}from"./Alert-DnMC6g2-.js";import{P as xe}from"./PageHeader-YH3gAQyl.js";import{C as he}from"./ConfirmModal-CeKhFQNY.js";import{T as ge}from"./Skeleton-SF9Xco25.js";import{u as be}from"./useDebounced-AF9GRx8i.js";import{P as ve}from"./pen-line-bGgIeahG.js";import{T as je}from"./trash-2-Cc594ZsA.js";import{P as fe}from"./plus-DjT5a3QW.js";const ye=ae("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]),L=20;function ze({title:c,resource:h,columns:f,fields:y,idKey:u="id",parseList:q,transformSubmit:M,customUpdate:D}){const{t:s}=re(),g=t.useMemo(()=>{const e={};return y.forEach(r=>{e[r.name]=r.defaultValue??""}),e},[y]),[N,W]=t.useState([]),[n,p]=t.useState(g),[x,T]=t.useState(null),[J,_]=t.useState(!1),[i,v]=t.useState(!1),[S,d]=t.useState(""),[R,m]=t.useState(""),[B,Q]=t.useState(""),P=be(B,300),[C,I]=t.useState(1),[$,z]=t.useState({open:!1,row:null});t.useEffect(()=>{w()},[]);const w=t.useCallback(async()=>{var e,r;v(!0),d("");try{const o=await A.list(h),l=q?q(o.data):o.data;W(Array.isArray(l)?l:[])}catch(o){d(((r=(e=o.response)==null?void 0:e.data)==null?void 0:r.error)||o.message)}finally{v(!1)}},[h,q]),O=t.useCallback(()=>{const e=y.filter(r=>r.required&&(n[r.name]===""||n[r.name]===void 0||n[r.name]===null));return e.length>0?(d(`${s("admin_required_fields","Faltan campos obligatorios")}: ${e.map(r=>r.label).join(", ")}`),!1):!0},[y,n,s]),X=t.useCallback(async e=>{var r,o;if(e.preventDefault(),!!O()){v(!0),d(""),m("");try{const l=M?M(n):n;x?(D?await D(x,l):await A.update(h,x,l),m(s("crud_record_updated","Registro actualizado correctamente"))):(await A.create(h,l),m(s("crud_record_created","Registro creado correctamente"))),_(!1),p(g),T(null),await w(),setTimeout(()=>m(""),3e3)}catch(l){d(((o=(r=l.response)==null?void 0:r.data)==null?void 0:o.error)||l.message)}finally{v(!1)}}},[O,n,x,D,h,M,g,w,s]),V=t.useCallback(e=>{T(e[u]);const r={...g};Object.keys(r).forEach(o=>{let l=e[o]??"";if(typeof l=="string"&&(l.startsWith("[")||l.startsWith("{")))try{l=JSON.parse(l)}catch{}r[o]=l}),p(r),_(!0),d(""),m("")},[u,g]),G=t.useCallback(e=>{z({open:!0,row:e})},[]),Z=t.useCallback(async()=>{var e,r;if($.row){v(!0),d(""),m("");try{await A.remove(h,$.row[u]),m(s("crud_record_deleted","Registro eliminado correctamente")),await w(),setTimeout(()=>m(""),3e3)}catch(o){d(((r=(e=o.response)==null?void 0:e.data)==null?void 0:r.error)||o.message)}finally{v(!1),z({open:!1,row:null})}}},[$.row,h,u,w,s]),Y=t.useCallback(()=>{_(!0),p(g),T(null),d(""),m("")},[g]),j=t.useMemo(()=>{const e=P.trim().toLowerCase();return e?N.filter(r=>f.some(o=>{const l=r[o.key];return l==null?!1:String(l).toLowerCase().includes(e)})):N},[N,P,f]),E=Math.ceil(j.length/L),H=t.useMemo(()=>{const e=(C-1)*L;return j.slice(e,e+L)},[j,C]);t.useEffect(()=>{I(1)},[P]);const U=t.useMemo(()=>[...f.map(e=>({key:e.key,header:e.label,render:e.render,sortAccessor:r=>r[e.key]})),{key:"acciones",header:s("common_acciones","Acciones"),render:e=>a.jsxs("div",{className:"flex gap-1.5",role:"group","aria-label":`${s("common_acciones","Acciones")} ${e[u]}`,children:[a.jsx(b,{variant:"secondary",className:"px-2.5 py-1.5 text-xs",onClick:()=>V(e),"aria-label":`${s("crud_edit","Editar")} ${c} ${e[u]}`,children:a.jsx(ve,{className:"w-3.5 h-3.5","aria-hidden":"true"})}),a.jsx(b,{variant:"danger",className:"px-2.5 py-1.5 text-xs",onClick:()=>G(e),"aria-label":`${s("common_eliminar","Eliminar")} ${c} ${e[u]}`,children:a.jsx(je,{className:"w-3.5 h-3.5","aria-hidden":"true"})})]})}],[f,s,u,c,V,G]);return a.jsxs("div",{className:"space-y-6",children:[a.jsx(xe,{title:c,description:`${s("crud_manage_catalog","Gestiona el catálogo de")} ${c.toLowerCase()} ${s("common_del_sistema","del sistema")}`,icon:se,children:a.jsxs(b,{onClick:Y,"aria-label":`${s("crud_new","Nuevo")} ${c}`,children:[a.jsx(fe,{className:"w-4 h-4","aria-hidden":"true"}),a.jsxs("span",{className:"ml-2",children:[s("crud_new","Nuevo")," ",c]})]})}),S&&a.jsx(F,{variant:"danger",onDismiss:()=>d(""),children:S}),R&&a.jsx(F,{variant:"success",onDismiss:()=>m(""),children:R}),a.jsxs(ne,{children:[a.jsxs(le,{className:"px-6 pt-6 pb-3",children:[a.jsx(oe,{children:c}),a.jsxs(ce,{children:[s("crud_total_records","Total de registros:")," ",j.length]})]}),a.jsxs(ie,{className:"px-6 pb-6 pt-1 space-y-4",children:[a.jsx("div",{className:"flex gap-3",children:a.jsx(ue,{value:B,onChange:e=>Q(e.target.value),placeholder:`${s("crud_search","Buscar")} ${c.toLowerCase()}...`,className:"flex-1"})}),i&&N.length===0?a.jsx(ge,{rows:5,columns:f.length+1}):a.jsxs(a.Fragment,{children:[a.jsx(pe,{columns:U,rows:H,emptyMessage:j.length===0&&N.length>0?s("crud_no_results_search","No hay resultados para la búsqueda"):`${s("crud_no_hay","No hay")} ${c.toLowerCase()} ${s("crud_no_items_created","creados")}`}),E>1&&a.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-[var(--border)]",children:[a.jsxs("div",{className:"text-sm text-[var(--fg-muted)]",children:[s("common_pagina","Página")," ",C," ",s("common_de","de")," ",E,a.jsxs("span",{className:"ml-2",children:["(",s("common_mostrando","Mostrando")," ",H.length," ",s("common_de","de")," ",j.length,")"]})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(b,{variant:"secondary",className:"px-3 py-1.5 text-sm",onClick:()=>I(e=>Math.max(1,e-1)),disabled:C===1,children:s("common_anterior","Anterior")}),a.jsx(b,{variant:"secondary",className:"px-3 py-1.5 text-sm",onClick:()=>I(e=>Math.min(E,e+1)),disabled:C===E,children:s("common_siguiente","Siguiente")})]})]})]})]})]}),J&&a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm",role:"presentation",children:a.jsxs("div",{className:"relative w-full max-w-2xl bg-[var(--card)] border border-[var(--border)] rounded-xl shadow-strong max-h-[90vh] overflow-auto",role:"dialog","aria-modal":"true","aria-labelledby":"crud-modal-title",children:[a.jsxs("div",{className:"sticky top-0 z-10 flex items-start justify-between p-6 border-b border-[var(--border)] bg-[var(--card)]",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h2",{id:"crud-modal-title",className:"text-xl font-semibold text-[var(--fg-strong)]",children:x?`${s("crud_edit","Editar")} ${c}`:`${s("crud_new","Nuevo")} ${c}`}),!x&&a.jsx("p",{className:"text-sm text-[var(--fg-muted)] mt-1",children:s("crud_complete_required","Completa los campos obligatorios")})]}),a.jsx("button",{type:"button",onClick:()=>_(!1),className:"flex-shrink-0 ml-4 p-2 rounded-lg text-[var(--fg-muted)] hover:text-[var(--fg-strong)] hover:bg-[var(--bg-elevated)] transition-all",disabled:i,"aria-label":s("common_cerrar","Cerrar"),children:a.jsx(te,{className:"w-5 h-5","aria-hidden":"true"})})]}),a.jsxs("form",{onSubmit:X,className:"p-6 space-y-4",children:[S&&a.jsx(F,{variant:"danger",onDismiss:()=>d(""),children:S}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:y.map(e=>e.type==="section"?a.jsx("div",{className:"md:col-span-2 pt-4 first:pt-0",children:a.jsxs("div",{className:"flex items-center gap-3 pb-3 border-b border-[var(--border)]",children:[e.icon&&a.jsx(e.icon,{className:"w-5 h-5 text-[var(--primary)]"}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-semibold text-[var(--fg-strong)] uppercase tracking-wide",children:e.label}),e.description&&a.jsx("p",{className:"text-xs text-[var(--fg-muted)] mt-0.5",children:e.description})]})]})},e.name):a.jsx("div",{className:e.type==="textarea"||e.fullWidth?"md:col-span-2":"",children:a.jsxs("label",{className:"block",children:[a.jsxs("span",{className:"text-sm font-medium text-[var(--fg)]",children:[e.label,e.required&&a.jsx("span",{className:"text-[var(--danger)] ml-1",children:"*"})]}),e.type==="textarea"?a.jsx("textarea",{className:"mt-2 w-full px-4 py-3 rounded-lg bg-[var(--input-bg)] border border-[var(--input-border)] text-sm text-[var(--fg)] placeholder:text-[var(--fg-subtle)] focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--input-focus)] focus:outline-none transition-all duration-200 resize-none",value:n[e.name]??"",onChange:r=>p({...n,[e.name]:r.target.value}),required:e.required,placeholder:e.placeholder,rows:3,disabled:i}):e.type==="checkbox"?a.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[a.jsx("input",{type:"checkbox",className:"w-4 h-4 rounded border-[var(--input-border)] text-[var(--primary)] focus:ring-[var(--primary)] focus:ring-offset-0",checked:!!n[e.name],onChange:r=>p({...n,[e.name]:r.target.checked?1:0}),disabled:i}),a.jsx("span",{className:"text-sm text-[var(--fg-muted)]",children:e.placeholder||e.label})]}):e.type==="checkbox-group"&&e.options?a.jsxs("div",{className:"mt-2 space-y-2 p-3 border border-[var(--input-border)] rounded-lg bg-[var(--input-bg)]",children:[e.options.map(r=>{const o=Array.isArray(n[e.name])?n[e.name]:typeof n[e.name]=="string"&&n[e.name]?JSON.parse(n[e.name]):[],l=o.includes(r.value);return a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("input",{type:"checkbox",className:"w-4 h-4 rounded border-[var(--input-border)] text-[var(--primary)] focus:ring-[var(--primary)] focus:ring-offset-0",checked:l,onChange:K=>{let k=[...o];K.target.checked?k.includes(r.value)||k.push(r.value):k=k.filter(ee=>ee!==r.value),p({...n,[e.name]:k})},disabled:i}),a.jsxs("label",{className:"text-sm text-[var(--fg)] cursor-pointer select-none",children:[r.label,r.description&&a.jsx("span",{className:"block text-xs text-[var(--fg-muted)] mt-0.5",children:r.description})]})]},r.value)}),e.placeholder&&a.jsx("p",{className:"text-xs text-[var(--fg-subtle)] mt-2 pt-2 border-t border-[var(--border)]",children:e.placeholder})]}):e.type==="select"&&e.options?a.jsxs(me,{className:"mt-2",value:n[e.name]??"",onChange:r=>p({...n,[e.name]:r.target.value}),required:e.required,disabled:i,children:[a.jsx("option",{value:"",children:e.placeholder||`${s("crud_select","Selecciona")} ${e.label.toLowerCase()}`}),e.options.map(r=>a.jsx("option",{value:r.value,children:r.label},r.value))]}):a.jsx(de,{type:e.type||"text",className:"mt-2",value:n[e.name]??"",onChange:r=>p({...n,[e.name]:r.target.value}),required:e.required,placeholder:e.placeholder,disabled:i})]})},e.name))}),a.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-[var(--border)]",children:[a.jsx(b,{variant:"ghost",type:"button",onClick:()=>_(!1),disabled:i,"aria-label":s("common_cancelar","Cancelar"),children:s("common_cancelar","Cancelar")}),a.jsx(b,{type:"submit",disabled:i,"aria-label":x?s("crud_update","Actualizar"):s("crud_create","Crear"),children:i?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-[var(--on-primary)]","aria-hidden":"true"}),a.jsx("span",{className:"ml-2",children:s("crud_saving","Guardando...")})]}):a.jsxs(a.Fragment,{children:[a.jsx(ye,{className:"w-4 h-4","aria-hidden":"true"}),a.jsx("span",{className:"ml-2",children:x?s("crud_update","Actualizar"):s("crud_create","Crear")})]})})]})]})]})}),a.jsx(he,{isOpen:$.open,onClose:()=>z({open:!1,row:null}),onConfirm:Z,title:s("common_eliminar","Eliminar"),description:s("crud_confirm_delete_record","¿Estás seguro de eliminar este registro?"),confirmText:s("common_eliminar","Eliminar"),cancelText:s("common_cancelar","Cancelar"),variant:"danger",loading:i})]})}export{ze as A};
