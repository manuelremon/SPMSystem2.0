# ğŸ”„ Flujo de Datos - Arquitectura Fase 2

## Diagrama de Componentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE (Frontend)                       â”‚
â”‚  TratarSolicitudModal.jsx â† ensureCsrfToken (CSRF centralizado) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  HTTP Request      â”‚
                    â”‚  POST/GET/PATCH    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAPA HTTP (Flask Routes)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ @bp.route('/solicitudes/<id>/analizar')                 â”‚   â”‚
â”‚  â”‚  â†’ guard, user = _require_solicitud_access(id)          â”‚   â”‚
â”‚  â”‚  â†’ resultado = paso_1_analizar_solicitud(id)  â—„â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â†’ return jsonify({"ok": True, "data": resultado})  â”‚   â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚   â”‚
â”‚  â”‚ @bp.route('.../opciones-abastecimiento')             â”‚   â”‚   â”‚
â”‚  â”‚  â†’ resultado = paso_2_opciones_abastecimiento(id)  â—„â”€â”¤   â”‚   â”‚
â”‚  â”‚  â†’ return jsonify(...)                               â”‚   â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚   â”‚
â”‚  â”‚ @bp.route('.../guardar-tratamiento')                 â”‚   â”‚   â”‚
â”‚  â”‚  â†’ resultado = paso_3_guardar_tratamiento(id)  â—„â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”‚  â†’ return jsonify(...)                               â”‚   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CAPA DE SERVICIOS (LÃ³gica)      â”‚
                    â”‚ planner_service.py               â”‚
                    â”‚                                  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚ paso_1_analizar_solicitud   â”‚ â”‚
                    â”‚  â”‚ â€¢ Validar solicitud existe  â”‚ â”‚
                    â”‚  â”‚ â€¢ Fetch presupuesto         â”‚ â”‚
                    â”‚  â”‚ â€¢ Detectar conflictos       â”‚ â”‚
                    â”‚  â”‚ â€¢ Return: ResultadoPaso1    â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚             â”‚                     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚ paso_2_opciones_abastem...  â”‚ â”‚
                    â”‚  â”‚ â€¢ Fetch item                â”‚ â”‚
                    â”‚  â”‚ â€¢ Generar 4 opciones        â”‚ â”‚
                    â”‚  â”‚ â€¢ Return: ResultadoPaso2    â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚             â”‚                     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚ paso_3_guardar_tratamiento  â”‚ â”‚
                    â”‚  â”‚ â€¢ Validar decisiones        â”‚ â”‚
                    â”‚  â”‚ â€¢ Guardar en BD             â”‚ â”‚
                    â”‚  â”‚ â€¢ Log evento                â”‚ â”‚
                    â”‚  â”‚ â€¢ Return: ResultadoPaso3    â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚             â”‚                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CAPA DE REPOSITORIO (CRUD)            â”‚
                    â”‚  repository.py                         â”‚
                    â”‚                                        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ SolicitudRepository            â”‚   â”‚
                    â”‚  â”‚ â€¢ get_by_id(id)                â”‚   â”‚
                    â”‚  â”‚ â€¢ get_items(id)                â”‚   â”‚
                    â”‚  â”‚ â€¢ update_status(id, status)    â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚             â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ PresupuestoRepository          â”‚   â”‚
                    â”‚  â”‚ â€¢ get_disponible(centro, sec)  â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚             â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ TratamientoRepository          â”‚   â”‚
                    â”‚  â”‚ â€¢ save_decision(...)           â”‚   â”‚
                    â”‚  â”‚ â€¢ log_evento(...)              â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚             â”‚                         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ MaterialRepository              â”‚   â”‚
                    â”‚  â”‚ â€¢ get_stock_detalle(...)       â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚             â”‚                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CAPA DE CACHÃ‰ (cache_loader.py)    â”‚
                    â”‚                                      â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ get_stock_cache()            â”‚  â”‚
                    â”‚  â”‚  â†’ ExcelCacheLoader.load()   â”‚  â”‚
                    â”‚  â”‚  â†’ Pandas DataFrame          â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                                      â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ get_equivalencias_cache()    â”‚  â”‚
                    â”‚  â”‚  â†’ from Excel file           â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ACCESO A DATOS               â”‚
                    â”‚                                  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚   SQLite DB (spm.db)     â”‚   â”‚
                    â”‚  â”‚   â€¢ solicitudes          â”‚   â”‚
                    â”‚  â”‚   â€¢ presupuestos         â”‚   â”‚
                    â”‚  â”‚   â€¢ materiales           â”‚   â”‚
                    â”‚  â”‚   â€¢ stock_almacenes      â”‚   â”‚
                    â”‚  â”‚   â€¢ proveedores          â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                                  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚  Excel Files             â”‚   â”‚
                    â”‚  â”‚  â€¢ stock.xlsx            â”‚   â”‚
                    â”‚  â”‚  â€¢ equivalencias.xlsx    â”‚   â”‚
                    â”‚  â”‚  â€¢ consumo.xlsx          â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚                                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujos de Uso - PASO 1

```
Cliente: POST /api/planificador/solicitudes/1/analizar

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analizar_solicitud(solicitud_id=1)                          â”‚
â”‚ [route handler, 15 lÃ­neas]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ paso_1_analizar_solicitud(solicitud_id=1)                   â”‚
â”‚ [services/planner_service.py, 120 lÃ­neas]                   â”‚
â”‚                                                              â”‚
â”‚  1. SolicitudRepository.get_by_id(1)                        â”‚
â”‚     â†’ SELECT * FROM solicitudes WHERE id=1                  â”‚
â”‚     â†’ return {"id": 1, "data_json": {...}, ...}             â”‚
â”‚                                                              â”‚
â”‚  2. SolicitudRepository.get_items(1)                        â”‚
â”‚     â†’ parse JSON â†’ return [item1, item2, ...]               â”‚
â”‚                                                              â”‚
â”‚  3. PresupuestoRepository.get_disponible(centro, sector)    â”‚
â”‚     â†’ SELECT monto, saldo FROM presupuestos                 â”‚
â”‚     â†’ return {"monto": 10000, "saldo": 8000}                â”‚
â”‚                                                              â”‚
â”‚  4. Loop items:                                             â”‚
â”‚     - get_stock_cache() â†’ Pandas DataFrame                  â”‚
â”‚     - Clasificar por criticidad                             â”‚
â”‚     - Detectar conflictos (stock, presupuesto)              â”‚
â”‚                                                              â”‚
â”‚  5. _generar_recomendaciones(conflictos, avisos)            â”‚
â”‚                                                              â”‚
â”‚  6. return ResultadoPaso1 â†’ Dict                            â”‚
â”‚     {                                                        â”‚
â”‚       "solicitud_id": 1,                                    â”‚
â”‚       "resumen": {...},                                     â”‚
â”‚       "conflictos": [...],                                  â”‚
â”‚       "avisos": [...],                                      â”‚
â”‚       "recomendaciones": [...]                              â”‚
â”‚     }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ return jsonify({"ok": True, "data": resultado}), 200        â”‚
â”‚                                                              â”‚
â”‚ Respuesta HTTP:                                             â”‚
â”‚ {                                                            â”‚
â”‚   "ok": true,                                               â”‚
â”‚   "data": {                                                 â”‚
â”‚     "solicitud_id": 1,                                      â”‚
â”‚     "paso": 1,                                              â”‚
â”‚     "resumen": {...},                                       â”‚
â”‚     "conflictos": [...],                                    â”‚
â”‚     "recomendaciones": [...]                                â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujos de Uso - PASO 2

```
Cliente: GET /api/planificador/solicitudes/1/items/0/opciones-abastecimiento

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ obtener_opciones_abastecimiento(solicitud_id=1, item_idx=0)  â”‚
â”‚ [route handler, 15 lÃ­neas]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ paso_2_opciones_abastecimiento(1, 0)                         â”‚
â”‚ [services/planner_service.py, 180 lÃ­neas]                    â”‚
â”‚                                                               â”‚
â”‚  1. SolicitudRepository.get_by_id(1)                         â”‚
â”‚     â†’ Fetch solicitud + items                                â”‚
â”‚                                                               â”‚
â”‚  2. item = items[0]                                          â”‚
â”‚     â†’ {"codigo": "MAT001", "cantidad": 10, ...}              â”‚
â”‚                                                               â”‚
â”‚  3. OPCIÃ“N 1: Stock Interno                                  â”‚
â”‚     get_stock_cache() â†’ filter by codigo                     â”‚
â”‚     â†’ {"opcion_id": "stock", "tipo": "stock", ...}           â”‚
â”‚                                                               â”‚
â”‚  4. OPCIÃ“N 2: Proveedores Externos                           â”‚
â”‚     ProveedorRepository.list_externos_activos()              â”‚
â”‚     â†’ rank by score (precio+plazo+rating)                    â”‚
â”‚     â†’ for prov in top3: add opcion                           â”‚
â”‚                                                               â”‚
â”‚  5. OPCIÃ“N 3: Equivalencias                                  â”‚
â”‚     get_equivalencias_cache() â†’ filter by codigo_base        â”‚
â”‚     â†’ for equiv: add opcion                                  â”‚
â”‚                                                               â”‚
â”‚  6. OPCIÃ“N 4: Mix (stock + proveedor)                        â”‚
â”‚     if stock < cantidad: add mix opcion                      â”‚
â”‚                                                               â”‚
â”‚  7. return ResultadoPaso2 â†’ Dict                             â”‚
â”‚     {                                                         â”‚
â”‚       "solicitud_id": 1,                                     â”‚
â”‚       "item_idx": 0,                                         â”‚
â”‚       "item": {...},                                         â”‚
â”‚       "opciones": [                                          â”‚
â”‚         {"opcion_id": "stock", "tipo": "stock", ...},        â”‚
â”‚         {"opcion_id": "prov_001", "tipo": "proveedor", ...}, â”‚
â”‚         {"opcion_id": "equiv_MAT002", "tipo": "equivalencia" â”‚
â”‚         {"opcion_id": "mix_prov_001", "tipo": "mix", ...}    â”‚
â”‚       ]                                                       â”‚
â”‚     }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ return jsonify({"ok": True, "data": resultado}), 200         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujos de Uso - PASO 3

```
Cliente: POST /api/planificador/solicitudes/1/guardar-tratamiento
Body: {"decisiones": [{"item_idx": 0, "decision_tipo": "stock", ...}]}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ guardar_tratamiento(solicitud_id=1)                            â”‚
â”‚ [route handler, 25 lÃ­neas]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ paso_3_guardar_tratamiento(1, decisiones, usuario_id="user1")  â”‚
â”‚ [services/planner_service.py, 100 lÃ­neas]                      â”‚
â”‚                                                                 â”‚
â”‚  1. SolicitudRepository.get_by_id(1)                           â”‚
â”‚     â†’ verify solicitud exists                                  â”‚
â”‚                                                                 â”‚
â”‚  2. for decision in decisiones:                                â”‚
â”‚     {                                                          â”‚
â”‚       "item_idx": 0,                                           â”‚
â”‚       "decision_tipo": "stock",                                â”‚
â”‚       "cantidad_aprobada": 10,                                 â”‚
â”‚       "codigo_material": "MAT001",                             â”‚
â”‚       ...                                                      â”‚
â”‚     }                                                          â”‚
â”‚                                                                 â”‚
â”‚  3. TratamientoRepository.save_decision(                       â”‚
â”‚       solicitud_id=1,                                          â”‚
â”‚       item_index=0,                                            â”‚
â”‚       decision_tipo="stock",                                   â”‚
â”‚       cantidad_aprobada=10,                                    â”‚
â”‚       codigo_material="MAT001",                                â”‚
â”‚       ...                                                      â”‚
â”‚     )                                                          â”‚
â”‚     â†’ INSERT OR UPDATE solicitud_items_tratamiento            â”‚
â”‚                                                                 â”‚
â”‚  4. TratamientoRepository.log_evento(                          â”‚
â”‚       1, 0, "decision_guardada", "PASO_3", payload            â”‚
â”‚     )                                                          â”‚
â”‚     â†’ INSERT solicitud_tratamiento_log                        â”‚
â”‚                                                                 â”‚
â”‚  5. SolicitudRepository.update_status(1, "En tratamiento")    â”‚
â”‚     â†’ UPDATE solicitudes SET status="En tratamiento"           â”‚
â”‚                                                                 â”‚
â”‚  6. return ResultadoPaso3 â†’ Dict                               â”‚
â”‚     {                                                          â”‚
â”‚       "solicitud_id": 1,                                       â”‚
â”‚       "paso": 3,                                               â”‚
â”‚       "status_actualizado": "tratamiento_guardado",            â”‚
â”‚       "cantidad_decisiones": 1,                                â”‚
â”‚       "decisiones": [                                          â”‚
â”‚         {"item_idx": 0, "decision_tipo": "stock", ...}         â”‚
â”‚       ]                                                        â”‚
â”‚     }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ return jsonify({"ok": True, "data": resultado}), 200           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Importancias de Capas

### 1ï¸âƒ£ Capa HTTP (routes)
- **Responsabilidad:** Parsing request, authorization, response formatting
- **Nunca:** LÃ³gica de negocio, queries DB directas
- **Siempre:** Delegar a servicios

### 2ï¸âƒ£ Capa de Servicios (services)
- **Responsabilidad:** LÃ³gica de negocio, orquestaciÃ³n
- **Nunca:** Acceso directo a BD (usar repositorio), response formatting
- **Siempre:** Retornar dicts puro Python (no JSONify)

### 3ï¸âƒ£ Capa de Repositorio (repository)
- **Responsabilidad:** CRUD, abstraer SQL
- **Nunca:** LÃ³gica de negocio, manejo de excepciones HTTP
- **Siempre:** Manejo automÃ¡tico de conexiones (try/finally)

### 4ï¸âƒ£ Capa de CachÃ© (cache_loader)
- **Responsabilidad:** Carga y caching de archivos Excel
- **Nunca:** Queries DB, formateo de respuestas
- **Siempre:** Retornar DataFrames normalizados

---

## Flujo de Errores

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Solicitud HTTP llega a ruta         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ValidaciÃ³n HTTP (guard, auth)        â”‚
â”‚ Â¿Error? â†’ return error_forbidden()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Llamar servicio paso_X_...()              â”‚
â”‚                                            â”‚
â”‚ Â¿ValueError? â†’ error_validation()         â”‚
â”‚ Â¿Exception? â†’ error_internal()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Servicio valida datos + repositorio   â”‚
â”‚                                        â”‚
â”‚ Â¿No existe? â†’ raise ValueError        â”‚
â”‚ Â¿Error DB? â†’ raise Exception          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Retorna resultado Dict â†’ HTTP         â”‚
â”‚ {"ok": True, "data": {...}}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ejemplo de Uso - Python REPL

```python
# Import servicios
from backend_v2.core.services.planner_service import paso_1_analizar_solicitud

# Ejecutar servicio
resultado = paso_1_analizar_solicitud(solicitud_id=1)

# Inspeccionar
print(resultado.keys())  # dict_keys(['solicitud_id', 'paso', 'resumen', ...])
print(resultado['conflictos'])  # List de conflictos detectados
print(resultado['recomendaciones'])  # Acciones sugeridas

# Serializar a JSON
import json
json_response = json.dumps(resultado)

# Envolver en respuesta HTTP
response = {"ok": True, "data": resultado}
```

---

## Testing - Ejemplo Unit Test

```python
# tests/test_planner_service.py
import pytest
from backend_v2.core.services.planner_service import paso_1_analizar_solicitud

def test_paso_1_solicitud_no_existe():
    """Test que paso_1 levanta ValueError si solicitud no existe"""
    with pytest.raises(ValueError, match="Solicitud .* no encontrada"):
        paso_1_analizar_solicitud(999)

def test_paso_1_retorna_estructura_correcta():
    """Test que paso_1 retorna estructura esperada"""
    resultado = paso_1_analizar_solicitud(1)

    assert "solicitud_id" in resultado
    assert "paso" in resultado
    assert resultado["paso"] == 1
    assert "conflictos" in resultado
    assert isinstance(resultado["conflictos"], list)
```

---

**Fin del documento de arquitectura**
