import{d as c,r as t,j as e,B as w,X as te,h as Ce,w as we}from"./index-CU87sTKb.js";import{S as $}from"./Select-Jm31NRtl.js";import{C as x,a as p,b as g,c as h,d as k}from"./Card-Dv3_2QFE.js";import{S as ce}from"./StatusBadge-BlWzzUNd.js";import{P as le}from"./PageHeader-DJVn98HH.js";import{A as ke}from"./Alert-a2bLf6zi.js";import{F as A}from"./Skeleton-OZPxOI8L.js";import"./styleConfig-Du6ydtW_.js";import"./x-circle-BHBn9rrs.js";import"./check-circle-BwZ1orHh.js";import"./archive-LgvwNYjp.js";import"./alert-circle-D7STJzyn.js";const i=()=>{const r=localStorage.getItem("token");return r?{Authorization:`Bearer ${r}`}:{}},_e=()=>c.get("/mi-cuenta",{headers:i()}),Me=()=>c.get("/mi-cuenta/solicitudes-cambio-perfil",{headers:i()}),Pe=r=>c.put("/mi-cuenta/password",r,{headers:i()}),ne=r=>c.put("/mi-cuenta/contacto",r,{headers:i()}),Ee=r=>c.post("/mi-cuenta/solicitud-cambio-perfil",r,{headers:i()}),$e=r=>c.post(`/mi-cuenta/solicitudes-cambio-perfil/${r}/cancelar`,{},{headers:i()}),Ae=(r,v)=>c.post(`/mi-cuenta/solicitudes-cambio-perfil/${r}/mensaje`,v,{headers:i()}),R={sectores:()=>c.get("/catalogos/sectores",{headers:i()}),centros:()=>c.get("/catalogos/centros",{headers:i()}),almacenes:()=>c.get("/catalogos/almacenes",{headers:i()}),usuarios:()=>c.get("/catalogos/usuarios",{headers:i()})},oe={sector_nuevo:"",centros_nuevos:[],almacenes_nuevos:[],jefe_nuevo:"",gerente1_nuevo:"",gerente2_nuevo:""};function Je(){const[r,v]=t.useState({}),[y,ie]=t.useState({sectores:[],centros:[],almacenes:[],usuarios:[]}),[b,S]=t.useState(oe),[T,de]=t.useState([]),[ue,D]=t.useState(!0),[F,q]=t.useState(""),[O,I]=t.useState(""),[_,H]=t.useState(""),[U,L]=t.useState(!1),[J,M]=t.useState(""),[u,X]=t.useState({nueva:"",repetir:""}),[K,Q]=t.useState(!1),[V,j]=t.useState(""),[W,Y]=t.useState(!1),[Z,m]=t.useState(""),[me,P]=t.useState(!1),[N,xe]=t.useState(null),[E,z]=t.useState(""),[G,ee]=t.useState(!1),[pe,ae]=t.useState(null);t.useEffect(()=>{(async()=>{D(!0);try{await Promise.all([ge(),he(),B()])}catch(s){console.error("MiCuenta init error:",s),q("No se pudo cargar Mi Cuenta. Intenta recargar.")}finally{D(!1)}})()},[]);const ge=async()=>{const s=(await _e()).data||{};v(s),I(s.telefono||""),H(s.mail_respaldo||"")},he=async()=>{try{const[a,s,l,n]=await Promise.all([R.sectores(),R.centros(),R.almacenes(),R.usuarios().catch(()=>({data:[]}))]);ie({sectores:a.data||[],centros:s.data||[],almacenes:l.data||[],usuarios:n.data||[]})}catch(a){console.error("Catalogos Mi Cuenta:",a),q("No se pudieron cargar catalogos.")}},B=async()=>{try{const a=await Me();de(a.data||[])}catch(a){console.error("Solicitudes perfil:",a)}},se=(a,s)=>{X(l=>({...l,[a]:s})),j("")},ve=async()=>{var l,n,f;const a=u.nueva||u.repetir,s=_.trim()!==(r.mail_respaldo||"");if(!a&&!s){j("Completa una nueva contrasena o mail de respaldo.");return}if(a&&(u.nueva||"").length<8){j("La contrasena debe tener al menos 8 caracteres.");return}if(a&&u.nueva!==u.repetir){j("Las contrasenas no coinciden.");return}Q(!0),j("");try{a&&(await Pe({password_nueva:u.nueva,password_nueva_repetida:u.repetir}),X({nueva:"",repetir:""})),s&&(await ne({mail_respaldo:_.trim()}),v(Se=>({...Se,mail_respaldo:_.trim()})));const C=[];a&&C.push("Contrasena actualizada"),s&&C.push("Mail de respaldo actualizado"),j(`${C.join(" | ")}.`)}catch(C){console.error("Security update:",C),j(((f=(n=(l=C.response)==null?void 0:l.data)==null?void 0:n.error)==null?void 0:f.message)||"No se pudo actualizar.")}finally{Q(!1)}},fe=async()=>{var s,l,n;const a=O.trim();if(!/^[0-9+\s-]{6,}$/.test(a)){M("Telefono invalido.");return}L(!0),M("");try{await ne({telefono:a}),M("Telefono actualizado.")}catch(f){console.error("Phone update:",f),M(((n=(l=(s=f.response)==null?void 0:s.data)==null?void 0:l.error)==null?void 0:n.message)||"No se pudo actualizar.")}finally{L(!1)}},re=(a,s)=>{const l=Array.from(a.target.selectedOptions).map(n=>n.value);S(n=>({...n,[s]:l})),m("")},be=async()=>{var a,s,l;Y(!0),m("");try{await Ee(b),m("Solicitud enviada para aprobacion."),S(oe),await B()}catch(n){console.error("Solicitud cambio perfil:",n),m(((l=(s=(a=n.response)==null?void 0:a.data)==null?void 0:s.error)==null?void 0:l.message)||"No se pudo enviar la solicitud.")}finally{Y(!1)}},je=async a=>{var s,l,n;if(confirm(`Â¿Cancelar solicitud de cambio de perfil del ${a.fecha}?`)){ae(a.id);try{await $e(a.id),m("Solicitud cancelada exitosamente."),await B(),setTimeout(()=>m(""),3e3)}catch(f){console.error("Error cancelando solicitud:",f),m(((n=(l=(s=f.response)==null?void 0:s.data)==null?void 0:l.error)==null?void 0:n.message)||"No se pudo cancelar la solicitud.")}finally{ae(null)}}},Ne=a=>{xe(a),z(""),P(!0)},ye=async()=>{var a,s,l;if(!E.trim()){alert("Escribe un mensaje antes de enviar.");return}ee(!0);try{await Ae(N.id,{mensaje:E.trim()}),m("Mensaje enviado al administrador."),P(!1),z(""),setTimeout(()=>m(""),3e3)}catch(n){console.error("Error enviando mensaje:",n),alert(((l=(s=(a=n.response)==null?void 0:a.data)==null?void 0:s.error)==null?void 0:l.message)||"No se pudo enviar el mensaje.")}finally{ee(!1)}};return ue?e.jsxs("div",{className:"space-y-6",children:[e.jsx(le,{title:"MI CUENTA"}),e.jsxs("section",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs(x,{children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg font-black",children:"Datos de identidad"})}),e.jsx(h,{children:e.jsx(A,{rows:3})})]}),e.jsxs(x,{children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg font-black",children:"Datos de contacto"})}),e.jsx(h,{children:e.jsx(A,{rows:3})})]})]}),e.jsxs("section",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs(x,{children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg font-black",children:"Seguridad"})}),e.jsx(h,{children:e.jsx(A,{rows:4})})]}),e.jsxs(x,{children:[e.jsx(p,{children:e.jsx(g,{className:"text-lg font-black",children:"Configuracion sujeta a aprobacion"})}),e.jsx(h,{children:e.jsx(A,{rows:8})})]})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(le,{title:"MI CUENTA"}),F&&e.jsx(ke,{variant:"danger",onDismiss:()=>q(""),children:F}),e.jsxs("section",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs(x,{className:"h-full",children:[e.jsxs(p,{children:[e.jsx(g,{className:"text-lg font-black",children:"Datos de identidad"}),e.jsx(k,{className:"text-sm text-[var(--fg-muted)]",children:"Informacion personal y de cuenta"})]}),e.jsxs(h,{className:"pt-1 space-y-3",children:[e.jsx(d,{label:"Nombre y Apellido",value:r.nombre_apellido||"-"}),e.jsx(d,{label:"ID Usuario SPM",value:r.id_usuario_spm||"-"}),e.jsx(d,{label:"Nombre Usuario",value:r.nombre_usuario||"-"})]})]}),e.jsxs(x,{className:"h-full",children:[e.jsxs(p,{children:[e.jsx(g,{className:"text-lg font-black",children:"Datos de contacto"}),e.jsx(k,{className:"text-sm text-[var(--fg-muted)]",children:"Mail y telefono"})]}),e.jsxs(h,{className:"pt-1 space-y-3",children:[e.jsx(d,{label:"Mail",value:r.mail||"-"}),e.jsx(o,{label:"Telefono",children:e.jsx("input",{type:"text",value:O,onChange:a=>I(a.target.value),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none",placeholder:"+34 600 000 000"})}),J&&e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:J}),e.jsx("div",{className:"flex justify-end",children:e.jsx(w,{className:"px-5 py-3",disabled:U,onClick:fe,type:"button",children:U?"Guardando...":"Guardar contacto"})})]})]})]}),e.jsxs("section",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs(x,{className:"h-full",children:[e.jsxs(p,{children:[e.jsx(g,{className:"text-lg font-black",children:"Seguridad"}),e.jsx(k,{className:"text-sm text-[var(--fg-muted)]",children:"Contrasena y mail de respaldo"})]}),e.jsxs(h,{className:"pt-1 space-y-3",children:[e.jsx(o,{label:"Nueva contrasena",children:e.jsx("input",{type:"password",value:u.nueva,onChange:a=>se("nueva",a.target.value),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none",placeholder:"Min 8 caracteres"})}),e.jsx(o,{label:"Repetir nueva contrasena",children:e.jsx("input",{type:"password",value:u.repetir,onChange:a=>se("repetir",a.target.value),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none",placeholder:"Repite la contrasena"})}),e.jsx(o,{label:"Mail de respaldo",children:e.jsx("input",{type:"email",value:_,onChange:a=>H(a.target.value),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none",placeholder:"ejemplo@respaldo.com"})}),V&&e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:V}),e.jsx("div",{className:"flex justify-end",children:e.jsx(w,{className:"px-5 py-3",disabled:K,onClick:ve,type:"button",children:K?"Guardando...":"Guardar seguridad"})})]})]}),e.jsxs(x,{className:"h-full",children:[e.jsxs(p,{children:[e.jsx(g,{className:"text-lg font-black",children:"Configuracion sujeta a aprobacion"}),e.jsx(k,{className:"text-sm text-[var(--fg-muted)]",children:"Solicita cambios de sector, centros y responsables"})]}),e.jsxs(h,{className:"pt-1 space-y-3",children:[e.jsx(o,{label:"Rol SPM",children:e.jsx(d,{label:"",value:r.rol_spm||"-"})}),e.jsx(o,{label:"Sector actual",children:e.jsx("input",{className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--bg-soft)] text-sm text-[var(--fg)]",value:r.sector_actual||"-",readOnly:!0})}),e.jsx(o,{label:"Solicitar cambio de Sector",children:e.jsxs($,{value:b.sector_nuevo,onChange:a=>S(s=>({...s,sector_nuevo:a.target.value})),children:[e.jsx("option",{value:"",children:"Sin cambio"}),(y.sectores||[]).map(a=>e.jsx("option",{value:a.id,children:`${a.id} - ${a.nombre||a.descripcion||""}`},a.id))]})}),e.jsx(o,{label:"Centros actuales",children:e.jsx(d,{label:"",value:(r.centros_actuales||[]).join(", ")||"-"})}),e.jsx(o,{label:"Solicitar acceso a nuevos Centros",children:e.jsx("select",{multiple:!0,value:b.centros_nuevos,onChange:a=>re(a,"centros_nuevos"),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none h-28",children:(y.centros||[]).map(a=>e.jsx("option",{value:a.id,children:`${a.id} - ${a.nombre||a.descripcion||""}`},a.id))})}),e.jsx(o,{label:"Almacenes actuales",children:e.jsx(d,{label:"",value:(r.almacenes_actuales||[]).join(", ")||"-"})}),e.jsx(o,{label:"Solicitar acceso a nuevos Almacenes",children:e.jsx("select",{multiple:!0,value:b.almacenes_nuevos,onChange:a=>re(a,"almacenes_nuevos"),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none h-28",children:(y.almacenes||[]).map(a=>e.jsx("option",{value:a.id,children:`${a.id} - ${a.nombre||a.descripcion||""}`},a.id))})}),e.jsx(o,{label:"Jefe actual",children:e.jsx(d,{label:"",value:r.jefe_actual||"-"})}),e.jsx(o,{label:"Solicitar cambio de Jefe",children:e.jsxs($,{value:b.jefe_nuevo,onChange:a=>S(s=>({...s,jefe_nuevo:a.target.value})),children:[e.jsx("option",{value:"",children:"Sin cambio"}),(y.usuarios||[]).map(a=>e.jsx("option",{value:a.id,children:`${a.nombre||a.username||a.id}`},a.id))]})}),e.jsx(o,{label:"Gerente 1 actual",children:e.jsx(d,{label:"",value:r.gerente1_actual||"-"})}),e.jsx(o,{label:"Solicitar cambio Gerente 1",children:e.jsxs($,{value:b.gerente1_nuevo,onChange:a=>S(s=>({...s,gerente1_nuevo:a.target.value})),children:[e.jsx("option",{value:"",children:"Sin cambio"}),(y.usuarios||[]).map(a=>e.jsx("option",{value:a.id,children:`${a.nombre||a.username||a.id}`},a.id))]})}),e.jsx(o,{label:"Gerente 2 actual",children:e.jsx(d,{label:"",value:r.gerente2_actual||"-"})}),e.jsx(o,{label:"Solicitar cambio Gerente 2",children:e.jsxs($,{value:b.gerente2_nuevo,onChange:a=>S(s=>({...s,gerente2_nuevo:a.target.value})),children:[e.jsx("option",{value:"",children:"Sin cambio"}),(y.usuarios||[]).map(a=>e.jsx("option",{value:a.id,children:`${a.nombre||a.username||a.id}`},a.id))]})}),Z&&e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:Z}),e.jsx("div",{className:"flex justify-end",children:e.jsx(w,{className:"px-5 py-3",disabled:W,onClick:be,type:"button",children:W?"Enviando...":"Solicitar actualizacion de datos de perfil"})})]})]})]}),e.jsx("section",{className:"grid grid-cols-1",children:e.jsxs(x,{className:"h-full",children:[e.jsxs(p,{children:[e.jsx(g,{className:"text-lg font-black",children:"Solicitudes de actualizacion de perfil"}),e.jsx(k,{className:"text-sm text-[var(--fg-muted)]",children:"Historial de cambios solicitados"})]}),e.jsxs(h,{className:"pt-1 space-y-3",children:[T.length===0&&e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:"Sin solicitudes pendientes."}),T.length>0&&e.jsx("div",{className:"overflow-x-auto rounded-xl border border-[var(--border)]",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--bg-soft)] text-[var(--fg)] border-b border-[var(--border)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-black uppercase tracking-[0.04em] text-[var(--fg-muted)]",children:"Fecha"}),e.jsx("th",{className:"px-3 py-2 text-left font-black uppercase tracking-[0.04em] text-[var(--fg-muted)]",children:"Campos"}),e.jsx("th",{className:"px-3 py-2 text-left font-black uppercase tracking-[0.04em] text-[var(--fg-muted)]",children:"Estado"}),e.jsx("th",{className:"px-3 py-2 text-left font-black uppercase tracking-[0.04em] text-[var(--fg-muted)]",children:"Comentario"}),e.jsx("th",{className:"px-3 py-2 text-center font-black uppercase tracking-[0.04em] text-[var(--fg-muted)]",children:"Acciones"})]})}),e.jsx("tbody",{children:T.map((a,s)=>e.jsxs("tr",{className:s%2?"bg-[var(--bg-soft)]":"bg-[var(--card)]",children:[e.jsx("td",{className:"px-3 py-2 text-[var(--fg)] border-b border-[var(--border)]",children:a.fecha||"-"}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)] border-b border-[var(--border)]",children:(a.campos||[]).join(", ")||"-"}),e.jsx("td",{className:"px-3 py-2 border-b border-[var(--border)]",children:Re(a.estado)}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)] border-b border-[var(--border)]",children:a.comentario||"-"}),e.jsx("td",{className:"px-3 py-2 border-b border-[var(--border)]",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[a.estado==="pendiente"&&e.jsx("button",{onClick:()=>je(a),disabled:pe===a.id,className:"p-2 rounded-lg hover:bg-[var(--bg-elevated)] text-[var(--fg-muted)] hover:text-[var(--danger)] transition-colors disabled:opacity-50",title:"Cancelar solicitud",children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Ne(a),className:"p-2 rounded-lg hover:bg-[var(--bg-elevated)] text-[var(--fg-muted)] hover:text-[var(--primary)] transition-colors",title:"Enviar mensaje al admin",children:e.jsx(Ce,{className:"w-4 h-4"})})]})})]},a.id||a.fecha))})]})})]})]})}),me&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-[var(--card)] rounded-2xl shadow-2xl max-w-lg w-full p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-black text-[var(--fg)]",children:"Mensaje al Administrador"}),e.jsx("button",{onClick:()=>P(!1),className:"p-2 rounded-lg hover:bg-[var(--bg-elevated)] text-[var(--fg-muted)] hover:text-[var(--fg)] transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm text-[var(--fg-muted)]",children:["Solicitud del ",(N==null?void 0:N.fecha)||"-"]}),e.jsxs("p",{className:"text-sm text-[var(--fg-muted)]",children:["Estado: ",e.jsx(ce,{estado:(N==null?void 0:N.estado)||"pendiente",className:"px-2 py-1 ml-1"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs uppercase font-bold tracking-[0.06em] text-[var(--fg-muted)]",children:"Tu mensaje"}),e.jsx("textarea",{value:E,onChange:a=>z(a.target.value),className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none resize-none",rows:4,placeholder:"Escribe tu mensaje al administrador..."})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(w,{variant:"ghost",onClick:()=>P(!1),disabled:G,children:"Cancelar"}),e.jsxs(w,{onClick:ye,disabled:G||!E.trim(),className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),G?"Enviando...":"Enviar mensaje"]})]})]})})]})}function o({label:r,children:v}){return e.jsxs("div",{className:"space-y-2",children:[r&&e.jsx("p",{className:"text-xs uppercase font-bold tracking-[0.06em] text-[var(--fg-muted)]",children:r}),v]})}function d({label:r,value:v}){return e.jsxs("div",{className:"flex flex-col gap-1",children:[r&&e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:r}),e.jsx("input",{className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--bg-soft)] text-sm text-[var(--fg)]",value:v,readOnly:!0})]})}function Re(r){return e.jsx(ce,{estado:r||"pendiente",className:"px-2 py-1"})}export{Je as default};
