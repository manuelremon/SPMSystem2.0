import{c as U,a as A,r as t,d as y,j as e,F as P,X as q,h as z,e as K,B as T,x as R,b as B}from"./index-BBtzFSXJ.js";import{C as H}from"./Card-CijqnRsN.js";import{P as V}from"./PageHeader-C_MWntDI.js";import{A as F}from"./Alert-QlGB6BLm.js";import{L as D}from"./loader-2-DzwzfvKu.js";import{M as G}from"./mail-DkGG44GX.js";import{I as L}from"./inbox-oGp0S2vU.js";import{T as O}from"./trash-2-CrOt4tP1.js";import"./info-DUgdjQgb.js";import"./alert-circle-ULNVDQrJ.js";import"./x-circle-CtG45re9.js";import"./check-circle-DVILKVSI.js";const I=U("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),X=U("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]);function J({message:s,isOpen:x,onClose:n}){const{user:p}=A(),[o,f]=t.useState([]),[j,u]=t.useState(!1),[S,m]=t.useState(null),[h,b]=t.useState(""),[g,N]=t.useState(!1),w=t.useRef(null);t.useEffect(()=>{x&&s&&k()},[x,s]),t.useEffect(()=>{var r;(r=w.current)==null||r.scrollIntoView({behavior:"smooth"})},[o]);const k=async()=>{u(!0),m(null);try{const l=(await y.get(`/mensajes/${s.id}/thread`)).data;l.ok?f(l.thread||[]):m(l.error||"Error al cargar conversación")}catch(r){m("Error de conexión al cargar conversación"),console.error(r)}finally{u(!1)}},v=async()=>{if(h.trim()){N(!0),m(null);try{const l=(await y.post(`/mensajes/${s.id}/reply`,{mensaje:h})).data;l.ok?(await k(),b("")):m(l.error||"Error al enviar respuesta")}catch(r){m("Error de conexión al enviar respuesta"),console.error(r)}finally{N(!1)}}},_=r=>{r.key==="Enter"&&(r.ctrlKey||r.metaKey)&&v()};return x?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative w-full max-w-3xl max-h-[90vh] bg-[var(--card)] border border-[var(--border)] rounded-xl shadow-strong flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex items-start justify-between p-6 border-b border-[var(--border)]",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--fg-strong)] mb-1",children:s.asunto}),s.solicitud_id&&e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-[var(--accent)]",children:[e.jsx(P,{className:"w-4 h-4"}),e.jsxs("span",{children:["Solicitud #",s.solicitud_id]}),s.solicitud_justificacion&&e.jsxs("span",{className:"text-[var(--fg-subtle)]",children:["- ",s.solicitud_justificacion]})]})]}),e.jsx("button",{onClick:n,className:"flex-shrink-0 ml-4 p-2 rounded-lg text-[var(--fg-muted)] hover:text-[var(--fg-strong)] hover:bg-[var(--bg-elevated)] transition-all",children:e.jsx(q,{className:"w-5 h-5"})})]}),S&&e.jsx("div",{className:"px-6 pt-4",children:e.jsx(F,{variant:"error",onDismiss:()=>m(null),children:S})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:j?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(D,{className:"w-8 h-8 text-[var(--primary)] animate-spin"})}):o.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(z,{className:"w-12 h-12 mx-auto text-[var(--fg-muted)] mb-3"}),e.jsx("p",{className:"text-[var(--fg-muted)]",children:"No se encontraron mensajes"})]}):e.jsxs(e.Fragment,{children:[o.map((r,l)=>{var E;const d=r.remitente_id===(p==null?void 0:p.id_spm),$=d?"Tú":`${r.remitente_nombre||""} ${r.remitente_apellido||""}`.trim()||"Usuario";return e.jsx("div",{className:`flex ${d?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] ${d?"items-end":"items-start"} space-y-1`,children:[e.jsxs("div",{className:`flex items-center gap-2 ${d?"flex-row-reverse":"flex-row"}`,children:[e.jsx("div",{className:`
                          w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold
                          ${d?"bg-gradient-to-br from-[var(--primary)] to-[var(--primary-strong)] text-[var(--on-primary)]":"bg-[var(--bg-elevated)] text-[var(--fg-muted)]"}
                        `,children:(E=$[0])==null?void 0:E.toUpperCase()}),e.jsxs("div",{className:`flex items-center gap-2 ${d?"flex-row-reverse":"flex-row"}`,children:[e.jsx("span",{className:"text-sm font-medium text-[var(--fg)]",children:$}),r.remitente_rol&&!d&&e.jsx("span",{className:"text-xs text-[var(--fg-subtle)] uppercase tracking-wider font-mono",children:r.remitente_rol})]})]}),e.jsx("div",{className:`
                          px-4 py-3 rounded-lg
                          ${d?"bg-gradient-to-r from-[var(--primary)] to-[var(--primary-strong)] text-[var(--on-primary)] rounded-tr-none":"bg-[var(--bg-elevated)] text-[var(--fg)] border border-[var(--border)] rounded-tl-none"}
                        `,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:r.mensaje})}),e.jsxs("div",{className:`flex items-center gap-1 text-xs text-[var(--fg-subtle)] ${d?"flex-row-reverse":"flex-row"}`,children:[e.jsx(K,{className:"w-3 h-3"}),e.jsx("span",{children:new Date(r.created_at).toLocaleString("es-AR",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})})]})]})},r.id)}),e.jsx("div",{ref:w})]})}),e.jsxs("div",{className:"p-6 border-t border-[var(--border)] bg-[var(--bg-soft)]",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("textarea",{value:h,onChange:r=>b(r.target.value),onKeyDown:_,placeholder:"Escribe tu respuesta... (Ctrl+Enter para enviar)",className:`\r
                flex-1 px-4 py-3 rounded-lg\r
                bg-[var(--input-bg)] border border-[var(--input-border)]\r
                text-sm text-[var(--fg)]\r
                placeholder:text-[var(--fg-subtle)]\r
                focus:border-[var(--primary)] focus:ring-2 focus:ring-[var(--input-focus)]\r
                focus:outline-none\r
                transition-all duration-200\r
                resize-none\r
                min-h-[80px]\r
              `,disabled:g}),e.jsxs(T,{onClick:v,disabled:!h.trim()||g,className:"self-end",title:"Enviar respuesta (Ctrl+Enter)",children:[g?e.jsx(D,{className:"w-4 h-4 animate-spin"}):e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline ml-2",children:"Enviar"})]})]}),e.jsxs("p",{className:"mt-2 text-xs text-[var(--fg-subtle)]",children:["Presiona ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-[var(--bg-elevated)] border border-[var(--border)] rounded font-mono",children:"Ctrl"})," + ",e.jsx("kbd",{className:"px-1.5 py-0.5 bg-[var(--bg-elevated)] border border-[var(--border)] rounded font-mono",children:"Enter"})," para enviar"]})]})]})}):null}function de(){const{user:s}=A(),{t:x}=B(),[n,p]=t.useState("inbox"),[o,f]=t.useState([]),[j,u]=t.useState([]),[S,m]=t.useState(!1),[h,b]=t.useState(null),[g,N]=t.useState(null),[w,k]=t.useState(!1),[v,_]=t.useState(0);t.useEffect(()=>{r(),l()},[n]);const r=async()=>{m(!0),b(null);try{const a=n==="inbox"?"/mensajes/inbox":"/mensajes/outbox",c=(await y.get(a)).data;c.ok?n==="inbox"?f(c.messages||[]):u(c.messages||[]):b(c.error||"Error al cargar mensajes")}catch(a){b("Error de conexión al cargar mensajes"),console.error(a)}finally{m(!1)}},l=async()=>{try{const i=(await y.get("/mensajes/unread-count")).data;i.ok&&_(i.unread_count||0)}catch(a){console.error("Error fetching unread count:",a)}},d=async a=>{if(N(a),k(!0),n==="inbox"&&a.leido===0)try{await y.post(`/mensajes/${a.id}/mark-read`),f(i=>i.map(c=>c.id===a.id?{...c,leido:1}:c)),_(i=>Math.max(0,i-1))}catch(i){console.error("Error marking as read:",i)}},$=async a=>{if(confirm("¿Estás seguro de que deseas eliminar este mensaje?"))try{const c=(await y.delete(`/mensajes/${a}`)).data;c.ok?(n==="inbox"?f(C=>C.filter(M=>M.id!==a)):u(C=>C.filter(M=>M.id!==a)),l()):alert(c.error||"Error al eliminar mensaje")}catch(i){alert("Error de conexión al eliminar mensaje"),console.error(i)}},E=n==="inbox"?o:j;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(V,{title:x("mensajes_title","Mensajes"),description:x("mensajes_desc","Gestiona tus mensajes de entrada y salida"),icon:G,children:v>0&&e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-[var(--primary-muted)] border border-[var(--primary)] rounded-lg",children:[e.jsx(I,{className:"w-2 h-2 fill-[var(--primary)] text-[var(--primary)] animate-pulse-dot"}),e.jsxs("span",{className:"text-sm font-medium text-[var(--primary)]",children:[v," ",v===1?"mensaje nuevo":"mensajes nuevos"]})]})}),h&&e.jsx(F,{variant:"error",onDismiss:()=>b(null),children:h}),e.jsxs(H,{children:[e.jsx("div",{className:"border-b border-[var(--border)]",children:e.jsxs("div",{className:"flex gap-1 p-2",children:[e.jsxs("button",{onClick:()=>p("inbox"),className:`
                flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium
                transition-all duration-200
                ${n==="inbox"?"bg-[var(--primary-muted)] text-[var(--primary)] border border-[var(--primary)]":"text-[var(--fg-muted)] hover:text-[var(--fg)] hover:bg-[var(--bg-elevated)]"}
              `,children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{children:"Recibidos"}),v>0&&e.jsx("span",{className:"ml-1 px-2 py-0.5 bg-[var(--primary)] text-[var(--on-primary)] text-xs font-bold rounded-full",children:v})]}),e.jsxs("button",{onClick:()=>p("outbox"),className:`
                flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium
                transition-all duration-200
                ${n==="outbox"?"bg-[var(--primary-muted)] text-[var(--primary)] border border-[var(--primary)]":"text-[var(--fg-muted)] hover:text-[var(--fg)] hover:bg-[var(--bg-elevated)]"}
              `,children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"Enviados"})]})]})}),e.jsx("div",{className:"p-6",children:S?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--primary)]"}),e.jsx("p",{className:"mt-3 text-sm text-[var(--fg-muted)]",children:"Cargando mensajes..."})]}):E.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 mx-auto rounded-full bg-[var(--bg-elevated)] flex items-center justify-center mb-4",children:n==="inbox"?e.jsx(L,{className:"w-8 h-8 text-[var(--fg-muted)]"}):e.jsx(R,{className:"w-8 h-8 text-[var(--fg-muted)]"})}),e.jsx("p",{className:"text-[var(--fg-muted)]",children:n==="inbox"?"No tienes mensajes recibidos":"No has enviado mensajes"})]}):e.jsx("div",{className:"space-y-2",children:E.map(a=>e.jsx(Q,{message:a,isInbox:n==="inbox",onOpen:()=>d(a),onDelete:()=>$(a.id)},a.id))})})]}),w&&g&&e.jsx(J,{message:g,isOpen:w,onClose:()=>{k(!1),N(null),r(),l()}})]})}function Q({message:s,isInbox:x,onOpen:n,onDelete:p}){const o=x&&s.leido===0,f=x?`${s.remitente_nombre||""} ${s.remitente_apellido||""}`.trim()||"Usuario":`${s.destinatario_nombre||""} ${s.destinatario_apellido||""}`.trim()||"Usuario",j=x?s.remitente_rol:s.destinatario_rol;return e.jsxs("div",{className:`
        group relative
        flex items-center gap-4 p-4
        border border-[var(--border)] rounded-lg
        hover:border-[var(--border-hover)] hover:bg-[var(--bg-elevated)]
        transition-all duration-200 cursor-pointer
        ${o?"bg-[var(--primary-muted)]/20 border-[var(--primary)]/30":""}
      `,onClick:n,children:[e.jsx("div",{className:`
        flex-shrink-0 w-10 h-10 rounded-full
        flex items-center justify-center
        ${o?"bg-[var(--primary)] text-[var(--on-primary)]":"bg-[var(--bg-elevated)] text-[var(--fg-muted)]"}
      `,children:o?e.jsx(I,{className:"w-4 h-4 fill-current"}):e.jsx(z,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-2 mb-1",children:[e.jsx("h3",{className:`text-sm font-medium truncate ${o?"text-[var(--fg-strong)]":"text-[var(--fg)]"}`,children:f}),j&&e.jsx("span",{className:"text-xs text-[var(--fg-subtle)] uppercase tracking-wider font-mono",children:j})]}),e.jsx("p",{className:`text-sm mb-1 truncate ${o?"font-medium text-[var(--fg)]":"text-[var(--fg-muted)]"}`,children:s.asunto}),e.jsx("p",{className:"text-xs text-[var(--fg-subtle)] line-clamp-1",children:s.mensaje}),s.solicitud_id&&e.jsxs("div",{className:"mt-2 flex items-center gap-1.5 text-xs text-[var(--accent)]",children:[e.jsx(P,{className:"w-3 h-3"}),e.jsxs("span",{children:["Solicitud #",s.solicitud_id]})]})]}),e.jsxs("div",{className:"flex-shrink-0 flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-[var(--fg-subtle)]",children:[e.jsx(K,{className:"w-3 h-3"}),e.jsx("span",{children:new Date(s.created_at).toLocaleDateString("es-AR",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(T,{variant:"ghost",size:"sm",onClick:u=>{u.stopPropagation(),n()},title:"Ver conversación",children:e.jsx(X,{className:"w-4 h-4"})}),e.jsx(T,{variant:"ghost",size:"sm",onClick:u=>{u.stopPropagation(),p()},title:"Eliminar",className:"text-[var(--danger)] hover:bg-[var(--status-danger-bg)]",children:e.jsx(O,{className:"w-4 h-4"})})]})]})]})}export{de as default};
