import{a as H,b as Q,r as o,j as e,B as n,p as V,P as X}from"./index-Sv0ImAih.js";import{s as N}from"./spm-CEYuI1MD.js";import{S as q}from"./SearchInput-CkzbeQL0.js";import{C as J,a as G,b as K,d as W,c as Y}from"./Card-Dxkx64Zs.js";import{D as Z}from"./DataTable-D5Kg2PzX.js";import{g as D}from"./styleConfig-C9yLMt_s.js";import{P as ee}from"./PageHeader-eKYThyjS.js";import{A as M}from"./Alert-CqYdOks6.js";import{T as ae}from"./Skeleton-jl73WAaQ.js";import{f}from"./formatters-Ctz0mOCI.js";import{u as te}from"./useDebounced-BHBN3yOV.js";import{M as E}from"./Modal-DsPy8HQI.js";import{E as se}from"./eye-CE7LABvj.js";import{C as I}from"./check-circle-C7xi_Sig.js";import{X as L}from"./x-circle-CAJHshED.js";import"./search-BEsG_P-c.js";import"./inbox-0lzeGquB.js";import"./chevron-up-Dikz9dln.js";import"./archive-DdCsdsUn.js";import"./alert-circle-B4RDZmxs.js";const re=300;function Ae(){var R,$;const{user:oe}=H(),{t:s}=Q(),[v,T]=o.useState([]),[y,m]=o.useState(""),[g,_]=o.useState(!1),[C,O]=o.useState(""),k=te(C,re),[A,x]=o.useState(""),[l,u]=o.useState({open:!1,id:null,motivo:""}),[S,w]=o.useState(!1),[r,h]=o.useState({open:!1,solicitud:null}),d=o.useCallback(async()=>{var a,t,i;_(!0),m("");try{const c=await N.listar({estado:"Enviada"}),p=c.data.solicitudes||c.data.results||[];T(p)}catch(c){m(((i=(t=(a=c.response)==null?void 0:a.data)==null?void 0:t.error)==null?void 0:i.message)||c.message)}finally{_(!1)}},[]);o.useEffect(()=>{d()},[d]);const P=o.useCallback(async()=>{w(!0),await d(),w(!1)},[d]),B=o.useMemo(()=>{const a=k.trim().toLowerCase();return a?v.filter(t=>String(t.id).includes(a)||(t.justificacion||"").toLowerCase().includes(a)||(t.centro||"").toLowerCase().includes(a)||(t.sector||"").toLowerCase().includes(a)||(t.estado||"").toLowerCase().includes(a)):v},[v,k]),j=o.useCallback(async a=>{var t,i,c;x(""),m("");try{await N.aprobar(a),x(s("aprov_aprobada_msg","Solicitud aprobada y asignada a planificador.")),setTimeout(()=>x(""),3e3),d()}catch(p){m(((c=(i=(t=p.response)==null?void 0:t.data)==null?void 0:i.error)==null?void 0:c.message)||p.message)}},[d,s]),b=o.useCallback(a=>{u({open:!0,id:a,motivo:""})},[]),F=o.useCallback(async()=>{var t,i,c;if(!l.id)return;x(""),m("");const a=l.motivo.trim()||"Rechazada";try{await N.rechazar(l.id,a),x(s("aprov_rechazada_msg","Solicitud rechazada.")),setTimeout(()=>x(""),3e3),d()}catch(p){m(((c=(i=(t=p.response)==null?void 0:t.data)==null?void 0:i.error)==null?void 0:c.message)||p.message)}finally{u({open:!1,id:null,motivo:""})}},[l.id,l.motivo,d,s]),z=o.useCallback(a=>{h({open:!0,solicitud:a})},[]),U=o.useMemo(()=>[{key:"id",header:"ID",sortAccessor:a=>Number(a.id)||0,render:a=>e.jsxs("span",{className:"font-semibold text-[var(--fg)]",children:["#",a.id]})},{key:"solicitante",header:s("aprov_solicitante","Solicitante"),sortAccessor:a=>`${a.solicitante_nombre||""} ${a.solicitante_apellido||""}`.toLowerCase(),render:a=>{const t=`${a.solicitante_nombre||""} ${a.solicitante_apellido||""}`.trim();return e.jsx("span",{className:"text-[var(--fg)]",title:t,children:t||"-"})}},{key:"centro",header:s("aprov_centro","CENTRO"),sortAccessor:a=>a.centro||"",render:a=>e.jsx("span",{className:"font-mono text-sm",children:a.centro||"-"})},{key:"almacen",header:s("aprov_almacen","ALMACEN"),sortAccessor:a=>a.almacen_virtual||a.almacen||"",render:a=>e.jsx("span",{className:"font-mono text-sm",children:a.almacen_virtual||a.almacen||"-"})},{key:"sector",header:s("aprov_sector","SECTOR"),sortAccessor:a=>a.sector||"",render:a=>e.jsx("span",{className:"text-sm",children:a.sector||"-"})},{key:"fecha_creacion",header:s("aprov_fecha_creacion","F. CREACIÓN"),sortAccessor:a=>a.created_at||"",render:a=>{const t=a.created_at;if(!t)return e.jsx("span",{className:"text-sm text-[var(--fg-muted)]",children:"-"});const i=new Date(t);return e.jsx("span",{className:"text-sm text-[var(--fg)]",children:i.toLocaleDateString("es-AR",{day:"2-digit",month:"2-digit",year:"2-digit"})})}},{key:"fecha_necesidad",header:s("aprov_fecha_necesidad","F. NECESIDAD"),sortAccessor:a=>a.fecha_necesidad||"",render:a=>{const t=a.fecha_necesidad;if(!t)return e.jsx("span",{className:"text-sm text-[var(--fg-muted)]",children:"-"});const i=new Date(t);return e.jsx("span",{className:"text-sm text-[var(--fg)]",children:i.toLocaleDateString("es-AR",{day:"2-digit",month:"2-digit",year:"2-digit"})})}},{key:"criticidad",header:s("aprov_criticidad","Criticidad"),sortAccessor:a=>({Urgente:0,Alta:1,Normal:2,Baja:3})[a.criticidad]??2,render:a=>{const t=D(a.criticidad),i=t.icon;return e.jsxs("div",{className:"flex items-center justify-center gap-1.5",children:[e.jsx(i,{className:"w-4 h-4",style:{color:t.color}}),e.jsx("span",{style:{color:t.color},className:"text-xs font-semibold uppercase",children:t.label})]})}},{key:"total_monto",header:s("aprov_monto","Monto"),sortAccessor:a=>Number(a.total_monto||0),render:a=>e.jsx("span",{className:"font-mono text-sm text-[var(--fg)]",children:f(a.total_monto)})},{key:"items_count",header:s("aprov_items","Items"),sortAccessor:a=>{var t;return((t=a.items)==null?void 0:t.length)||0},render:a=>{var t;return e.jsx("span",{className:"text-sm font-semibold text-[var(--fg)]",children:((t=a.items)==null?void 0:t.length)||0})}},{key:"acciones",header:s("aprov_acciones","Acciones"),render:a=>e.jsxs("div",{className:"flex gap-2 flex-wrap justify-center",role:"group","aria-label":`${s("aprov_acciones","Acciones")} solicitud ${a.id}`,children:[e.jsxs(n,{variant:"ghost",className:"px-3 py-2 text-xs",onClick:()=>z(a),type:"button","aria-label":`Ver detalle solicitud ${a.id}`,children:[e.jsx(se,{className:"w-3.5 h-3.5 mr-1","aria-hidden":"true"}),s("aprov_ver","Ver")]}),e.jsxs(n,{className:"px-3 py-2 text-xs",onClick:()=>j(a.id),type:"button","aria-label":`${s("aprov_aprobar","Aprobar")} solicitud ${a.id}`,children:[e.jsx(I,{className:"w-3.5 h-3.5 mr-1","aria-hidden":"true"}),s("aprov_aprobar","Aprobar")]}),e.jsxs(n,{variant:"danger",className:"px-3 py-2 text-xs",onClick:()=>b(a.id),type:"button","aria-label":`${s("aprov_rechazar","Rechazar")} solicitud ${a.id}`,children:[e.jsx(L,{className:"w-3.5 h-3.5 mr-1","aria-hidden":"true"}),s("aprov_rechazar","Rechazar")]})]})}],[s,j,b,z]);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{title:"APROBACIONES",actions:e.jsxs(n,{variant:"ghost",onClick:P,disabled:S||g,"aria-label":s("common_refresh","Actualizar"),children:[e.jsx(V,{className:`w-4 h-4 mr-2 ${S?"animate-spin":""}`}),s("common_refresh","Actualizar")]})}),y&&e.jsx(M,{variant:"danger",onDismiss:()=>m(""),children:y}),A&&e.jsx(M,{variant:"success",onDismiss:()=>x(""),children:A}),e.jsxs(J,{className:"transition-all duration-200",children:[e.jsx(G,{children:e.jsxs("div",{children:[e.jsx(K,{children:s("aprov_title","Aprobaciones")}),e.jsx(W,{className:"text-sm text-[var(--fg-muted)]",children:s("aprov_subtitle","Solicitudes pendientes")})]})}),e.jsxs(Y,{className:"pt-1 space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 md:items-center md:justify-between",children:[e.jsx(q,{value:C,onChange:a=>O(a.target.value),placeholder:s("aprov_search_placeholder","Buscar por ID, centro, sector o justificacion"),className:"md:max-w-md"}),g&&e.jsx("div",{className:"text-xs font-bold uppercase tracking-[0.05em] text-[var(--fg-muted)]",children:s("aprov_loading","Cargando...")})]}),g?e.jsx(ae,{rows:5,columns:11}):e.jsx(Z,{columns:U,rows:B,emptyMessage:s("aprov_no_items","No hay solicitudes pendientes")})]})]}),e.jsx(E,{isOpen:l.open,onClose:()=>u({open:!1,id:null,motivo:""}),title:`${s("aprov_rechazar","Rechazar")} #${l.id}`,size:"md",footer:e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"ghost",onClick:()=>u({open:!1,id:null,motivo:""}),type:"button",children:s("common_cancelar","Cancelar")}),e.jsx(n,{variant:"danger",onClick:F,type:"button","aria-label":`${s("aprov_rechazar","Rechazar")} solicitud ${l.id}`,children:s("aprov_rechazar","Rechazar")})]}),children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"reject-motivo",className:"text-sm text-[var(--fg-muted)]",children:s("aprov_motivo","Motivo de rechazo")}),e.jsx("textarea",{id:"reject-motivo",value:l.motivo,onChange:a=>u(t=>({...t,motivo:a.target.value})),rows:3,className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none transition-all",placeholder:s("planner_rechazar_placeholder","Explica brevemente el motivo del rechazo..."),"aria-label":s("aprov_motivo","Motivo de rechazo")})]})}),e.jsx(E,{isOpen:r.open,onClose:()=>h({open:!1,solicitud:null}),title:`${s("aprov_detalle","Detalle Solicitud")} #${((R=r.solicitud)==null?void 0:R.id)||""}`,size:"lg",footer:e.jsxs("div",{className:"flex gap-2 justify-end w-full",children:[e.jsx(n,{variant:"ghost",onClick:()=>h({open:!1,solicitud:null}),type:"button",children:s("common_cerrar","Cerrar")}),e.jsxs(n,{onClick:()=>{var a;j((a=r.solicitud)==null?void 0:a.id),h({open:!1,solicitud:null})},type:"button",children:[e.jsx(I,{className:"w-4 h-4 mr-1"}),s("aprov_aprobar","Aprobar")]}),e.jsxs(n,{variant:"danger",onClick:()=>{var a;h({open:!1,solicitud:null}),b((a=r.solicitud)==null?void 0:a.id)},type:"button",children:[e.jsx(L,{className:"w-4 h-4 mr-1"}),s("aprov_rechazar","Rechazar")]})]}),children:r.solicitud&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-[var(--bg-soft)] rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)] uppercase font-semibold mb-1",children:"Solicitante"}),e.jsx("p",{className:"text-sm text-[var(--fg)]",children:`${r.solicitud.solicitante_nombre||""} ${r.solicitud.solicitante_apellido||""}`.trim()||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)] uppercase font-semibold mb-1",children:"Centro"}),e.jsx("p",{className:"text-sm text-[var(--fg)] font-mono",children:r.solicitud.centro||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)] uppercase font-semibold mb-1",children:"Sector"}),e.jsx("p",{className:"text-sm text-[var(--fg)]",children:r.solicitud.sector||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)] uppercase font-semibold mb-1",children:"Criticidad"}),e.jsx("div",{className:"flex items-center gap-1",children:(()=>{const a=D(r.solicitud.criticidad),t=a.icon;return e.jsxs(e.Fragment,{children:[e.jsx(t,{className:"w-4 h-4",style:{color:a.color}}),e.jsx("span",{style:{color:a.color},className:"text-sm font-semibold",children:a.label})]})})()})]})]}),r.solicitud.justificacion&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)] uppercase font-semibold mb-2",children:"Justificación"}),e.jsx("p",{className:"text-sm text-[var(--fg)] p-3 bg-[var(--bg-soft)] rounded-lg",children:r.solicitud.justificacion})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(X,{className:"w-5 h-5 text-[var(--primary)]"}),e.jsxs("p",{className:"text-sm font-semibold text-[var(--fg)]",children:[s("aprov_materiales_titulo","Materiales Solicitados")," (",(($=r.solicitud.items)==null?void 0:$.length)||0,")"]})]}),r.solicitud.items&&r.solicitud.items.length>0?e.jsx("div",{className:"overflow-x-auto rounded-xl border border-[var(--border)]",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--bg-soft)] border-b border-[var(--border)]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:"Código SAP"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:"Descripción"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:"P. Unit."}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-bold uppercase tracking-wider text-[var(--fg-muted)]",children:"Subtotal"})]})}),e.jsx("tbody",{className:"divide-y divide-[var(--border)]",children:r.solicitud.items.map((a,t)=>e.jsxs("tr",{className:t%2===0?"bg-[var(--card)]":"bg-[var(--bg-soft)]",children:[e.jsx("td",{className:"px-4 py-3 font-mono text-sm text-[var(--fg)]",children:a.codigo_sap||a.material_id||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-[var(--fg)]",children:a.descripcion||a.nombre||"-"}),e.jsxs("td",{className:"px-4 py-3 text-center text-sm text-[var(--fg)]",children:[a.cantidad||0," ",a.unidad_medida||a.uom||"UN"]}),e.jsx("td",{className:"px-4 py-3 text-right font-mono text-sm text-[var(--fg)]",children:f(a.precio_unitario||a.precio||0)}),e.jsx("td",{className:"px-4 py-3 text-right font-mono text-sm font-semibold text-[var(--fg)]",children:f((a.cantidad||0)*(a.precio_unitario||a.precio||0))})]},t))}),e.jsx("tfoot",{className:"bg-[var(--bg-soft)] border-t-2 border-[var(--border)]",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"px-4 py-3 text-right text-sm font-bold uppercase text-[var(--fg)]",children:"Total:"}),e.jsx("td",{className:"px-4 py-3 text-right font-mono text-base font-bold text-[var(--primary)]",children:f(r.solicitud.total_monto)})]})})]})}):e.jsx("p",{className:"text-sm text-[var(--fg-muted)] text-center py-6 bg-[var(--bg-soft)] rounded-lg",children:s("aprov_sin_materiales","No hay materiales en esta solicitud")})]})]})})]})}export{Ae as default};
