import{c as ke,r as d,j as e,B as E,n as Re,P as Ce,X as Se,w as Te,x as ee,d as H,s as $e,M as Le,a as Fe,b as qe,e as ye}from"./index-Sv0ImAih.js";import{p as pe,s as Oe}from"./spm-CEYuI1MD.js";import{C as K,a as ae,b as se,d as oe,c as W}from"./Card-Dxkx64Zs.js";import{D as ze}from"./DataTable-D5Kg2PzX.js";import{P as Be}from"./Pagination-BVo5HTMH.js";import{P as Ue}from"./PageHeader-eKYThyjS.js";import{A as _e}from"./Alert-CqYdOks6.js";import{S as le}from"./Select-D_IRS8Kb.js";import{I as Ie}from"./Input-D_iEem94.js";import{T as Ve}from"./Skeleton-jl73WAaQ.js";import{f as ne,g as re,a as ce,e as Ge}from"./formatters-Ctz0mOCI.js";import{D as Pe}from"./dollar-sign-ByS9KCG2.js";import{C as He}from"./chevron-up-Dikz9dln.js";import{T as Xe}from"./trending-up-CWvV34Az.js";import{C as be}from"./check-TZNe560r.js";import{S as Je}from"./StatusBadge-WR3bOBfa.js";import{r as Qe}from"./sectores-D5jxTgHT.js";import{M as Ke}from"./Modal-DsPy8HQI.js";import{u as We}from"./useDebounced-BHBN3yOV.js";import{E as Ye}from"./eye-CE7LABvj.js";import{P as Ze}from"./styleConfig-C9yLMt_s.js";import{X as Ae}from"./x-circle-CAJHshED.js";import{C as we}from"./check-circle-C7xi_Sig.js";import{P as ea}from"./pen-line-B-SutpiN.js";import"./inbox-0lzeGquB.js";import"./alert-circle-B4RDZmxs.js";import"./archive-DdCsdsUn.js";const aa=ke("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),sa=ke("RefreshCcw",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]);function ta({analisis:a={},solicitud:s={},onNext:i,onReject:t,onRequestInfo:r}){const o=a.resumen||{},u=a.conflictos||[],x=a.avisos||[],m=a.recomendaciones||[],N=a.materiales_por_criticidad||{};(o.diferencia_presupuesto||0)>=0;const[C,b]=d.useState(!1),[g,p]=d.useState(!1),[_,S]=d.useState(!1),L=u.some(y=>y.impacto_critico),M=u.length>0;return e.jsxs(K,{children:[e.jsxs(ae,{className:"px-5 pt-5 pb-3",children:[e.jsx(se,{children:"Analisis inicial"}),e.jsx(oe,{className:"text-sm text-[var(--fg-muted)]",children:"Presupuesto, criticidad y conflictos detectados"})]}),e.jsxs(W,{className:"px-5 pb-5 pt-1 space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(ra,{resumen:o,solicitud:s,onPresupuestoInsuficiente:()=>S(!0)}),e.jsx(ue,{title:"Conflictos",emptyLabel:"Sin conflictos detectados",items:u.map(y=>({label:y.impacto_critico?`⚠️ ${y.tipo}`:y.tipo,detail:y.descripcion||`Item ${y.item_idx} - ${y.codigo||""}`,sugerencia:y.sugerencia,tone:y.impacto_critico?"danger":"warning"})),collapsed:!C,onToggle:()=>b(y=>!y)}),e.jsx(ue,{title:"Avisos",emptyLabel:"Sin avisos",items:x.map(y=>({label:y.nivel||"info",detail:y.mensaje||"",tone:y.nivel==="warning"?"warning":"info"}))}),e.jsx(ue,{title:"Recomendaciones",emptyLabel:"Sin recomendaciones",items:m.map(y=>({label:y.accion,detail:y.razon,tone:y.prioridad==="muy_alta"?"danger":y.prioridad==="alta"?"warning":"info"})),collapsed:!g,onToggle:()=>p(y=>!y)})]}),e.jsx("div",{className:"min-w-0",children:e.jsx(na,{materiales:N,solicitud:s})})]}),(L||M)&&e.jsxs("div",{className:"flex flex-wrap gap-2 pt-4 border-t border-[var(--border)]",children:[L&&t&&e.jsx(E,{variant:"danger",onClick:t,type:"button",children:"Rechazar solicitud"}),M&&r&&e.jsx(E,{variant:"ghost",onClick:r,type:"button",children:"Solicitar información"})]})]}),_&&e.jsx(oa,{solicitud:s,isOpen:_,onClose:()=>S(!1)})]})}function ra({resumen:a,solicitud:s,onPresupuestoInsuficiente:i}){var N;const t=a.presupuesto_disponible||0,r=s.items||((N=s.data_json)==null?void 0:N.items)||[],o=r.reduce((C,b)=>{const g=Number(b.precio_unitario||0),p=Number(b.cantidad||0);return C+g*p},0),u=o>0?o:a.presupuesto_real_necesario||a.costo_total_solicitud||0,x=t-u,m=x>=0;return e.jsxs("div",{className:"p-4 md:p-5 rounded-xl border border-[var(--border)] bg-[var(--card)] space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"w-5 h-5 text-[var(--primary)]"}),e.jsx("p",{className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",title:"Análisis del presupuesto disponible vs costo de la solicitud",children:"Análisis Presupuestario"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-baseline gap-2",children:[e.jsx("span",{className:"text-sm text-[var(--fg-muted)]",title:"Presupuesto disponible en el centro/sector",children:"Presupuesto Disponible"}),e.jsx("span",{className:"text-base font-bold text-[var(--fg)]",children:ne(t)})]}),e.jsxs("div",{className:"flex justify-between items-baseline gap-2",children:[e.jsx("span",{className:"text-sm text-[var(--fg-muted)]",title:`Suma de (Precio Unitario × Cantidad) de ${r.length} ${r.length===1?"item":"items"}`,children:"Costo de la Solicitud"}),e.jsx("span",{className:"text-base font-bold text-[var(--fg)]",children:ne(u)})]}),e.jsx("div",{className:`p-3 rounded-lg border-2 ${m?"border-[var(--success)] bg-[rgba(52,211,153,0.06)]":"border-[var(--danger)] bg-[rgba(239,68,68,0.06)] cursor-pointer hover:bg-[rgba(239,68,68,0.12)] transition-all"}`,title:m?"El presupuesto disponible es suficiente":"Click para notificar al solicitante sobre presupuesto insuficiente",onClick:()=>!m&&i&&i(),children:e.jsxs("div",{className:"flex justify-between items-baseline gap-2",children:[e.jsx("span",{className:"text-sm font-semibold text-[var(--fg)]",children:"Balance"}),e.jsxs("span",{className:`text-lg font-black ${m?"text-[var(--success)]":"text-[var(--danger)]"}`,children:[x>=0?"+":"",ne(x)," ",m?"✓":"⚠️"]})]})})]})]})}function ue({title:a,items:s,emptyLabel:i,tone:t="info",collapsed:r=!1,onToggle:o}){const u={danger:{border:"border-[var(--danger)]",bg:"bg-[rgba(239,68,68,0.08)]",text:"text-[var(--danger)]"},warning:{border:"border-[var(--warning)]",bg:"bg-[rgba(251,146,60,0.08)]",text:"text-[var(--warning)]"},info:{border:"border-[var(--border)]",bg:"bg-[var(--bg-soft)]",text:"text-[var(--fg)]"},muted:{border:"border-[var(--border)]",bg:"bg-[var(--bg-soft)]",text:"text-[var(--fg-muted)]"}},x=u[t]||u.info,m=s.length;return e.jsxs("div",{className:"p-4 rounded-xl border border-[var(--border)] bg-[var(--card)] space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:a}),m>0&&e.jsx("span",{className:"inline-flex items-center justify-center min-w-[1.5rem] h-5 px-1.5 rounded-full bg-[var(--bg-soft)] text-xs font-bold text-[var(--fg)]",title:`${m} ${m===1?"item":"items"}`,children:m})]}),o?e.jsx("button",{type:"button",className:"p-1 rounded hover:bg-[var(--bg-hover)] text-[var(--primary)] hover:text-[var(--primary-hover)] transition-all",onClick:o,title:r?"Expandir sección":"Contraer sección",children:r?e.jsx(Re,{className:"w-4 h-4"}):e.jsx(He,{className:"w-4 h-4"})}):null]}),r?e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:m===0?i:`${m} ${m===1?"item":"items"} - Haz clic para expandir`}):s.length===0?e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:i}):e.jsx("ul",{className:"space-y-2",children:s.map((N,C)=>e.jsxs("li",{className:`px-3 py-2.5 rounded-lg border ${x.border} ${x.bg}`,children:[e.jsx("div",{className:`text-xs font-semibold uppercase tracking-[0.1em] ${x.text} mb-1`,children:N.label}),e.jsx("div",{className:"text-sm text-[var(--fg)] leading-relaxed",children:N.detail}),N.sugerencia&&e.jsx("div",{className:"text-xs text-[var(--fg-muted)] mt-2 italic pl-2 border-l-2 border-[var(--border)]",children:N.sugerencia})]},C))})]})}function na({materiales:a,solicitud:s}){var r;const i=[...a.Critico||[],...a.Normal||[],...a.Bajo||[]],t=i.length>0?i:(s.items||((r=s.data_json)==null?void 0:r.items)||[]).map((o,u)=>({idx:u,codigo:o.codigo,descripcion:o.descripcion||"Sin descripción",cantidad:o.cantidad,precio_unitario:o.precio_unitario,stock_disponible:o.stock_disponible,criticidad:o.criticidad||"Normal"}));return e.jsxs("div",{className:"p-4 md:p-5 rounded-xl border border-[var(--border)] bg-[var(--card)] space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"w-5 h-5 text-[var(--primary)]"}),e.jsx("p",{className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:"Materiales Solicitados"})]}),e.jsxs("span",{className:"text-sm font-bold text-[var(--fg)]",title:"Total de materiales en la solicitud",children:[t.length," ",t.length===1?"item":"items"]})]}),t.length===0?e.jsx("p",{className:"text-sm text-[var(--fg-muted)] text-center py-8",children:"Sin materiales en la solicitud"}):e.jsx(ia,{items:t})]})}function ia({items:a}){const s=[{key:"codigo",header:"Código",sortAccessor:i=>i.codigo||""},{key:"descripcion",header:"Descripción",render:i=>{const t=i.descripcion||"Sin descripción",r=t.length>50?t.substring(0,50)+"...":t;return e.jsx("span",{title:t,children:r})},sortAccessor:i=>i.descripcion||""},{key:"cantidad",header:"Cant.",render:i=>e.jsx("span",{className:"font-semibold",children:i.cantidad}),sortAccessor:i=>Number(i.cantidad||0)},{key:"precio_unitario",header:"P. Unit.",render:i=>ne(i.precio_unitario||0),sortAccessor:i=>Number(i.precio_unitario||0)},{key:"stock",header:"Stock",render:i=>{const t=i.stock_disponible;return t??"N/D"},sortAccessor:i=>Number(i.stock_disponible??-1)},{key:"criticidad",header:"Crit.",render:i=>{const t=i.criticidad||"Normal",r=t.toLowerCase().includes("critico")||t.toLowerCase().includes("crítico");return e.jsxs("span",{className:`inline-flex items-center gap-1 text-xs font-semibold ${r?"text-[var(--danger)]":"text-[var(--fg-muted)]"}`,title:`Criticidad: ${t}`,children:[r&&e.jsx($e,{className:"w-3.5 h-3.5"}),t]})},sortAccessor:i=>{const t=(i.criticidad||"Normal").toLowerCase();return t.includes("critico")||t.includes("crítico")?0:t.includes("normal")?1:2}}];return e.jsx("div",{className:"max-h-[600px] overflow-auto",children:e.jsx(ze,{columns:s,rows:a,emptyMessage:"Sin materiales"})})}function oa({solicitud:a,isOpen:s,onClose:i}){const[t,r]=d.useState(!1),[o,u]=d.useState(""),[x,m]=d.useState(!1),N={1:"Almacenes",2:"Compras",3:"Mantenimiento",4:"Planificación",5:"Operaciones",6:"Logística",7:"Producción",8:"Calidad"},C=a.sector_nombre||N[a.sector]||a.sector,b=a.solicitante_nombre||a.usuario_nombre||"",g=a.solicitante_apellido||a.usuario_apellido||"",p=`${b} ${g}`.trim()||a.id_usuario,_=`La solicitud #${a.id} no podrá ser procesada hasta tanto no se incorpore saldo al Centro ${a.centro} Sector "${C}".`,S=async()=>{var L,M,y;r(!0),u("");try{if(await ee(),await H.post("/mensajes",{destinatario_id:a.id_usuario,asunto:`Presupuesto insuficiente - Solicitud #${a.id}`,mensaje:_,solicitud_id:a.id,tipo:"presupuesto_insuficiente",metadata:{origen:"planificador",centro:a.centro,sector:a.sector}}),a.jefe||a.usuario_jefe){const v=a.jefe||a.usuario_jefe;await H.post("/mensajes",{destinatario_id:v,asunto:`[COPIA] Presupuesto insuficiente - Solicitud #${a.id}`,mensaje:`${_}

(Este mensaje es una copia del aviso enviado al solicitante ${a.id_usuario})`,solicitud_id:a.id,tipo:"presupuesto_insuficiente",metadata:{origen:"planificador",centro:a.centro,sector:a.sector,es_copia:!0}})}await H.patch(`/solicitudes/${a.id}`,{estado:"presupuesto_insuficiente",observaciones:_}),m(!0),setTimeout(()=>{i(),window.location.reload()},2e3)}catch(v){const A=((y=(M=(L=v.response)==null?void 0:L.data)==null?void 0:M.error)==null?void 0:y.message)||v.message||"Error al enviar notificación";u(A),console.error("Error al notificar presupuesto insuficiente:",v)}finally{r(!1)}};return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm",children:e.jsxs("div",{className:"relative w-full max-w-lg bg-[var(--card)] border border-[var(--border)] rounded-xl shadow-strong",children:[e.jsxs("div",{className:"flex items-start justify-between p-6 border-b border-[var(--border)]",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-semibold text-[var(--fg-strong)] mb-1",children:"Presupuesto Insuficiente"}),e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:"Notificar al solicitante sobre falta de presupuesto"})]}),e.jsx("button",{onClick:i,className:"flex-shrink-0 ml-4 p-2 rounded-lg text-[var(--fg-muted)] hover:text-[var(--fg-strong)] hover:bg-[var(--bg-elevated)] transition-all",disabled:t,children:e.jsx(Se,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[o&&e.jsx("div",{className:"p-4 rounded-lg bg-[var(--status-danger-bg)] border border-[var(--danger)] text-[var(--danger)] text-sm",children:o}),x&&e.jsx("div",{className:"p-4 rounded-lg bg-[var(--status-success-bg)] border border-[var(--success)] text-[var(--success)] text-sm",children:"✓ Notificación enviada exitosamente. El estado de la solicitud ha sido actualizado."}),!x&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-[var(--fg)]",children:"Mensaje a enviar:"}),e.jsx("div",{className:"p-4 rounded-lg bg-[var(--bg-soft)] border border-[var(--border)] text-sm text-[var(--fg)]",children:_})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:e.jsx("strong",{children:"Destinatarios:"})}),e.jsxs("ul",{className:"text-sm text-[var(--fg-muted)] space-y-1 ml-4",children:[e.jsxs("li",{children:["• Solicitante: ",e.jsx("strong",{className:"text-[var(--fg)]",children:p})]}),(a.jefe||a.usuario_jefe)&&e.jsxs("li",{children:["• Jefe (copia): ",e.jsx("strong",{className:"text-[var(--fg)]",children:a.jefe||a.usuario_jefe})]})]})]}),e.jsxs("div",{className:"p-4 rounded-lg bg-[var(--bg-elevated)] border border-[var(--border)]",children:[e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:"Al enviar esta notificación:"}),e.jsxs("ul",{className:"text-sm text-[var(--fg-muted)] space-y-1 ml-4 mt-2",children:[e.jsx("li",{children:"• Se notificará al solicitante y su jefe"}),e.jsxs("li",{children:["• El estado cambiará a ",e.jsx("strong",{className:"text-[var(--danger)]",children:"PRESUPUESTO (-)"})]}),e.jsx("li",{children:"• La solicitud quedará en espera hasta que se incorpore presupuesto"})]})]})]})]}),!x&&e.jsxs("div",{className:"flex justify-end gap-3 p-6 border-t border-[var(--border)]",children:[e.jsx(E,{variant:"ghost",onClick:i,disabled:t,children:"Cancelar"}),e.jsx(E,{onClick:S,disabled:t,children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-[var(--on-primary)]"}),e.jsx("span",{className:"ml-2",children:"Enviando..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Te,{className:"w-4 h-4"}),e.jsx("span",{className:"ml-2",children:"Enviar Notificación"})]})})]})]})}):null}function la({isOpen:a,onClose:s,detalleStock:i=[],almacenSolicitud:t,codigoMaterial:r,descripcionMaterial:o}){if(!a)return null;const u=i.filter(m=>Number(m.cantidad||0)>0),x=u.reduce((m,N)=>m+Number(N.cantidad||0),0);return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:s,children:e.jsxs("div",{className:"bg-[var(--card)] rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[80vh] overflow-hidden",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"px-6 py-4 border-b border-[var(--border)] flex justify-between items-center bg-[var(--bg-soft)]",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-[var(--fg)]",children:"Detalle de Stock por Ubicacion"}),r&&e.jsxs("p",{className:"text-sm text-[var(--fg-muted)]",children:[r,o&&` - ${o}`]})]}),e.jsx("button",{onClick:s,className:"p-2 rounded-lg hover:bg-[var(--bg-hover)] text-[var(--fg-muted)] hover:text-[var(--fg)] transition",children:e.jsx(Se,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-3 overflow-y-auto max-h-96",children:[u.map((m,N)=>e.jsx(ca,{stock:m,almacenSolicitud:t},N)),u.length===0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-[var(--fg-muted)]",children:"No hay stock disponible en ubicaciones validas"})})]}),e.jsx("div",{className:"px-6 py-4 border-t border-[var(--border)] bg-[var(--bg-soft)]",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-4 text-xs text-[var(--fg-muted)]",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-[var(--success)]"}),"Disponible"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-[var(--warning)]"}),"Requiere consulta"]})]}),e.jsxs("div",{className:"text-sm font-semibold text-[var(--fg)]",children:["Total: ",x," un."]})]})})]})})}function ca({stock:a,almacenSolicitud:s}){const i=String(a.almacen||"").padStart(4,"0"),r=a.libre_disponibilidad===!0||i==="0001"&&i===s;return e.jsxs("div",{className:`p-4 rounded-lg border-2 transition ${r?"border-[var(--success)] bg-[rgba(16,185,129,0.08)]":"border-[var(--warning)] bg-[rgba(245,158,11,0.08)]"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"font-bold text-[var(--fg)]",children:["Centro ",a.centro," / Almacen ",i]}),a.nombre_almacen&&e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:a.nombre_almacen}),a.lote&&e.jsxs("p",{className:"text-xs text-[var(--fg-muted)]",children:["Lote: ",a.lote]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xl font-black text-[var(--fg)]",children:a.cantidad||0}),e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:"unidades"})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide ${r?"bg-[rgba(16,185,129,0.15)] text-[var(--success)]":"bg-[rgba(245,158,11,0.15)] text-[var(--warning)]"}`,children:r?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-current"}),"Disponible"]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-current"}),"Requiere consulta"]})}),!r&&a.responsable&&e.jsxs("span",{className:"text-xs text-[var(--fg-muted)]",children:["Contactar: ",a.responsable]})]})]})}function da({solicitud:a,analisis:s,items:i=[],totalItems:t=0,currentIdx:r=0,onChangeIdx:o,opciones:u={},decisiones:x={},onSelectDecision:m,onFetchOpciones:N,loadingOpciones:C,onPrev:b,onNext:g}){var X;const p=i[r]||{},_=((X=u[r])==null?void 0:X.opciones)||[],S=x[r],L=t>0?(r+1)/t*100:0,[M,y]=d.useState(!1),[v,A]=d.useState("todos"),F=d.useMemo(()=>ha(p),[p]),[J,I]=d.useState(!1),O=d.useMemo(()=>v==="todos"?_:_.filter(h=>h.tipo===v),[_,v]),$=d.useMemo(()=>{const h={todos:_.length,stock:0,proveedor:0,equivalencia:0,mix:0};return _.forEach(V=>{const U=V.tipo||"otros";h[U]!==void 0&&h[U]++}),h},[_]);d.useEffect(()=>{r!=null&&(N==null||N(r))},[r,N]);const B=d.useMemo(()=>Object.entries(x).map(([h,V])=>({idx:Number(h),opcion:V,item:i.find(U=>Number(U.idx)===Number(h))||{}})),[x,i]),D=t-Object.keys(x).length,q=D===0,G=t>0?Object.keys(x).length/t*100:0;return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs(K,{className:"lg:col-span-2",children:[e.jsxs(ae,{className:"px-5 pt-5 pb-3",children:[e.jsx(se,{children:"Decision de abastecimiento"}),e.jsx(oe,{className:"text-sm text-[var(--fg-muted)]",children:"Selecciona la mejor opcion para cada material"})]}),e.jsxs(W,{className:"px-5 pb-5 pt-1 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs uppercase font-bold tracking-[0.1em] text-[var(--fg-muted)] mb-1",children:[e.jsxs("span",{children:["Item ",r+1," de ",t]}),e.jsxs("span",{children:[L.toFixed(0),"%"]})]}),e.jsx("div",{className:"h-2 bg-[var(--bg-soft)] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-[var(--primary)]",style:{width:`${L}%`}})})]}),e.jsxs("div",{className:"p-4 rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] space-y-2",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-lg font-black text-[var(--fg)]",children:[p.codigo,p.descripcion,ie(p.precio_unitario||0)].filter(Boolean).join(" / ")}),e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:`Cantidad solicitada: ${p.cantidad??"N/D"}`})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 pt-2 border-t border-[var(--border)]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-9 h-9 rounded-lg bg-[rgba(16,185,129,0.12)] flex items-center justify-center",children:e.jsx(Ce,{className:"w-4 h-4 text-[var(--success)]"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:"Stock disponible"}),p.detalle_stock&&p.detalle_stock.length>0&&e.jsx(ga,{detalle:p.detalle_stock})]}),e.jsxs("p",{className:"text-sm font-bold text-[var(--fg)]",children:[F.texto,F.valor!==null&&F.valor<(p.cantidad||0)&&e.jsx("span",{className:"ml-1 text-[var(--danger)] text-xs",children:"Insuficiente"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-9 h-9 rounded-lg bg-[rgba(59,130,246,0.12)] flex items-center justify-center",children:e.jsx(Xe,{className:"w-4 h-4 text-[var(--info)]"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:"Consumo promedio Anual"}),e.jsx("p",{className:"text-sm font-bold text-[var(--fg)]",children:p.consumo_promedio_anual!=null?Math.round(p.consumo_promedio_anual):p.consumo_promedio!=null?Math.round(Number(p.consumo_promedio)*12):"N/D"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-9 h-9 rounded-lg bg-[rgba(251,146,60,0.12)] flex items-center justify-center",children:e.jsx(Pe,{className:"w-4 h-4 text-[var(--primary)]"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:"Costo total"}),e.jsx("p",{className:"text-sm font-bold text-[var(--fg)]",children:ie((p.cantidad||0)*(p.precio_unitario||0))})]})]}),e.jsx("div",{className:"flex items-center",children:pa({item:p,mostrarMrp:J,setMostrarMrp:I})})]}),J&&fa(p)&&e.jsx(ua,{item:p,solicitud:a,onClose:()=>I(!1)})]}),_.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>A("todos"),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${v==="todos"?"bg-[var(--primary)] text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]"}`,children:["Todas (",$.todos,")"]}),$.stock>0&&e.jsxs("button",{type:"button",onClick:()=>A("stock"),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${v==="stock"?"bg-green-600 text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]"}`,children:["Stock Interno (",$.stock,")"]}),$.proveedor>0&&e.jsxs("button",{type:"button",onClick:()=>A("proveedor"),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${v==="proveedor"?"bg-blue-600 text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]"}`,children:["Proveedores (",$.proveedor,")"]}),$.equivalencia>0&&e.jsxs("button",{type:"button",onClick:()=>A("equivalencia"),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${v==="equivalencia"?"bg-purple-600 text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]"}`,children:["Equivalencias (",$.equivalencia,")"]}),$.mix>0&&e.jsxs("button",{type:"button",onClick:()=>A("mix"),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${v==="mix"?"bg-orange-600 text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]"}`,children:["Mix (",$.mix,")"]})]}),O.length>0&&e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>y(!1),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${M?"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]":"bg-[var(--primary)] text-white"}`,children:"Vista Grid"}),e.jsx("button",{type:"button",onClick:()=>y(!0),className:`px-3 py-1.5 text-xs font-semibold rounded-lg transition ${M?"bg-[var(--primary)] text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)] hover:bg-[var(--bg-hover)]"}`,children:"Vista Tabla"})]}),C&&_.length===0?e.jsx("div",{className:"text-sm text-[var(--fg-muted)]",children:"Cargando opciones..."}):M?e.jsx(ma,{opciones:O,selected:S,onSelect:h=>m==null?void 0:m(r,h)}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[O.map(h=>e.jsx(xa,{opcion:h,selected:(S==null?void 0:S.opcion_id)===h.opcion_id,onSelect:()=>m==null?void 0:m(r,h),almacenSolicitud:(a==null?void 0:a.almacen_virtual)||(a==null?void 0:a.almacen),codigoMaterial:p==null?void 0:p.codigo,descripcionMaterial:p==null?void 0:p.descripcion},h.opcion_id)),O.length===0&&_.length>0&&e.jsxs("div",{className:"text-sm text-[var(--fg-muted)] col-span-2",children:['No hay opciones del tipo "',v,'". Intenta con otro filtro.']}),_.length===0&&e.jsx("div",{className:"text-sm text-[var(--fg-muted)] col-span-2",children:"Sin opciones disponibles para este item."})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(E,{variant:"ghost",type:"button",onClick:b,children:"Volver"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{variant:"ghost",type:"button",onClick:()=>o==null?void 0:o(Math.max(0,r-1)),disabled:r===0,children:"Anterior"}),e.jsx(E,{variant:"ghost",type:"button",onClick:()=>{r<t-1?o==null||o(r+1):q&&(g==null||g())},disabled:r>=t-1&&!q,title:r<t-1?"Ir al siguiente item":q?"Continuar al siguiente paso":`Faltan ${D} items por decidir`,children:r<t-1?"Siguiente":q?"Continuar":`Faltan ${D}`})]})]})]})]}),e.jsxs(K,{children:[e.jsxs(ae,{className:"px-5 pt-5 pb-3",children:[e.jsx(se,{children:"Resumen de decisiones"}),e.jsxs(oe,{className:"text-sm text-[var(--fg-muted)]",children:["Seleccionadas ",B.length,"/",t]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex justify-between text-xs text-[var(--fg-muted)] mb-1",children:[e.jsx("span",{children:"Progreso total"}),e.jsxs("span",{className:"font-semibold",children:[G.toFixed(0),"%"]})]}),e.jsx("div",{className:"h-2 bg-[var(--bg-soft)] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full transition-all duration-300",style:{width:`${G}%`,backgroundColor:q?"var(--success)":"var(--info)"}})})]}),!q&&e.jsx("div",{className:"mt-3 px-3 py-2 rounded-lg bg-[rgba(245,158,11,0.12)] border border-[var(--warning)]",children:e.jsxs("p",{className:"text-xs font-semibold text-[var(--warning)]",children:["Faltan ",D," items por decidir"]})}),q&&B.length>0&&e.jsx("div",{className:"mt-3 px-3 py-2 rounded-lg bg-[rgba(16,185,129,0.12)] border border-[var(--success)]",children:e.jsx("p",{className:"text-xs font-semibold text-[var(--success)]",children:"Todos los items decididos"})})]}),e.jsxs(W,{className:"px-5 pb-5 pt-1 space-y-3 max-h-96 overflow-y-auto",children:[B.length===0&&e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:"Aun no seleccionaste opciones."}),B.map(h=>{var V,U,Y;return e.jsxs("div",{className:"p-3 rounded-lg border-2 border-[var(--success)] bg-[rgba(16,185,129,0.08)]",children:[e.jsxs("div",{className:"flex justify-between text-sm font-semibold text-[var(--fg)]",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(be,{className:"w-4 h-4 text-[var(--success)]"}),"Item ",h.idx+1]}),e.jsx("span",{children:h.item.codigo||"N/D"})]}),e.jsx("p",{className:"text-xs text-[var(--fg-muted)]",children:h.item.descripcion}),e.jsxs("p",{className:"text-sm mt-2 font-medium text-[var(--success)]",children:[((V=h.opcion)==null?void 0:V.nombre)||((U=h.opcion)==null?void 0:U.tipo)," — ",ie(((Y=h.opcion)==null?void 0:Y.precio_unitario)||0)]})]},h.idx)})]})]})]})}function xa({opcion:a,selected:s,onSelect:i,almacenSolicitud:t,codigoMaterial:r,descripcionMaterial:o}){const[u,x]=d.useState(!1),m=a.is_recomendada===!0,N=a.score_recomendacion||0,C=a.tipo==="stock"||a.tipo==="mix",b=a.detalle_stock||[];return e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:i,className:`text-left p-4 rounded-xl border-2 transition shadow-sm relative ${s?"border-[var(--primary)] bg-[rgba(59,130,246,0.1)]":m?"border-amber-500 bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-950 dark:to-amber-900 hover:border-amber-600":"border-[var(--border)] bg-[var(--card)] hover:border-[var(--primary)]"}`,children:[m&&e.jsxs("div",{className:"absolute top-2 right-2 px-2 py-1 rounded-full bg-gradient-to-r from-amber-500 to-amber-600 text-white text-xs font-bold shadow-md flex items-center gap-1",children:[e.jsx("span",{children:"⭐"}),e.jsx("span",{children:"RECOMENDADA"})]}),e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:a.tipo}),e.jsx("p",{className:"text-lg font-black text-[var(--fg)]",children:a.nombre})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-semibold text-[var(--fg)]",children:ie(a.precio_unitario||0)}),e.jsxs("p",{className:"text-xs text-[var(--fg-muted)]",children:["Plazo ",a.plazo_dias??"N/D"," d"]})]})]}),e.jsx("p",{className:"text-sm text-[var(--fg-muted)] mt-2",children:a.descripcion}),e.jsxs("div",{className:"flex flex-wrap gap-3 text-xs text-[var(--fg-muted)] mt-3",children:[e.jsxs("span",{children:["Disp: ",a.cantidad_disponible??a.cantidad_solicitada??"N/D"]}),e.jsxs("span",{children:["Compat: ",a.compatibilidad_pct??0,"%"]}),a.rating?e.jsxs("span",{children:["Rating: ",a.rating]}):null,N>0&&e.jsxs("span",{className:`font-semibold ${m?"text-amber-700 dark:text-amber-400":"text-[var(--fg)]"}`,children:["Score: ",N.toFixed(1),"/100"]})]}),a.observaciones?e.jsxs("p",{className:"text-xs text-[var(--fg)] mt-2",children:["Nota: ",a.observaciones]}):null,N>0&&e.jsx("div",{className:"mt-3",children:e.jsx("div",{className:"h-1.5 bg-[var(--bg-soft)] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full",style:{width:`${N}%`,backgroundColor:m?"var(--warning)":"var(--info)"}})})}),C&&b.length>0&&e.jsx("div",{className:"mt-3 pt-3 border-t border-[var(--border)]",onClick:g=>g.stopPropagation(),children:e.jsxs("button",{type:"button",onClick:g=>{g.stopPropagation(),x(!0)},className:"flex items-center gap-2 text-xs font-semibold text-[var(--info)] hover:text-[var(--primary)] transition",children:[e.jsx(Le,{className:"w-3.5 h-3.5"}),"Ver detalle de ubicaciones (",b.length,")"]})})]}),e.jsx(la,{isOpen:u,onClose:()=>x(!1),detalleStock:b,almacenSolicitud:t,codigoMaterial:r,descripcionMaterial:o})]})}function ma({opciones:a,selected:s,onSelect:i}){return e.jsxs("div",{className:"overflow-x-auto rounded-xl border border-[var(--border)]",children:[e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-[var(--border)] bg-[var(--bg-soft)]",children:[e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-[var(--fg)]",children:"Seleccionar"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-[var(--fg)]",children:"Opción"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold text-[var(--fg)]",children:"Precio U."}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-[var(--fg)]",children:"Plazo"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-[var(--fg)]",children:"Rating"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-[var(--fg)]",children:"Compat."}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-[var(--fg)]",children:"Score"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-[var(--fg)]",children:"Disponibilidad"})]})}),e.jsx("tbody",{children:a.map(t=>{const r=t.is_recomendada===!0,o=t.score_recomendacion||0,u=(s==null?void 0:s.opcion_id)===t.opcion_id;return e.jsxs("tr",{className:`border-b border-[var(--border)] transition hover:bg-[var(--bg-hover)] cursor-pointer ${u?"bg-[rgba(59,130,246,0.1)]":r?"bg-[rgba(245,158,11,0.08)]":""}`,onClick:()=>i(t),children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("input",{type:"radio",checked:u,onChange:()=>i(t),className:"w-4 h-4 cursor-pointer"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx("span",{className:"text-amber-600",children:"⭐"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-[var(--fg)]",children:t.nombre}),e.jsx("p",{className:"text-xs text-[var(--fg-muted)] uppercase",children:t.tipo})]})]})}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-[var(--fg)]",children:ie(t.precio_unitario||0)}),e.jsx("td",{className:"px-4 py-3 text-center text-[var(--fg)]",children:e.jsxs("span",{className:t.plazo_dias===1?"text-green-600 font-semibold":"",children:[t.plazo_dias??"N/D"," días"]})}),e.jsx("td",{className:"px-4 py-3 text-center text-[var(--fg)]",children:t.rating?`${t.rating}/5`:"N/D"}),e.jsxs("td",{className:"px-4 py-3 text-center text-[var(--fg)]",children:[t.compatibilidad_pct??0,"%"]}),e.jsx("td",{className:"px-4 py-3 text-center",children:o>0?e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:"font-bold",style:{color:r?"var(--warning)":"var(--fg)"},children:o.toFixed(1)}),e.jsx("div",{className:"w-16 h-1.5 bg-[var(--bg-soft)] rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full",style:{width:`${o}%`,backgroundColor:r?"var(--warning)":"var(--info)"}})})]}):"N/D"}),e.jsxs("td",{className:"px-4 py-3 text-left text-[var(--fg-muted)]",children:[t.cantidad_disponible??t.cantidad_solicitada??"N/D"," unidades"]})]},t.opcion_id)})})]}),a.length===0&&e.jsx("div",{className:"p-4 text-center text-sm text-[var(--fg-muted)]",children:"No hay opciones disponibles"})]})}function pa({item:a,mostrarMrp:s,setMostrarMrp:i}){const t=ve(a);if(!t.planificado)return e.jsx("span",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[rgba(239,68,68,0.12)] text-[var(--danger)] font-semibold text-xs uppercase tracking-[0.08em]",children:"MRP: NO"});const r=t.warn?"bg-amber-100 text-amber-800 animate-pulse":"bg-[rgba(16,185,129,0.15)] text-green-700";return e.jsxs("button",{type:"button",onClick:()=>i==null?void 0:i(!s),className:`w-full text-left px-3 py-2 rounded-lg border border-[var(--border)] ${r} font-semibold text-xs uppercase tracking-[0.08em]`,children:["MRP: SI",t.warn?e.jsx("span",{className:"block normal-case text-[var(--fg)] font-normal text-xs mt-1",children:"Stock + pedidos bajo punto de pedido"}):null]})}function ua({item:a,solicitud:s,onClose:i}){const t=ve(a),r=t.detalle,o=t.total;return e.jsxs("div",{className:"mt-3 p-4 rounded-xl border border-[var(--border)] bg-[var(--bg-soft)] space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-bold text-[var(--fg)]",children:"Detalle MRP"}),e.jsx("button",{type:"button",className:"text-xs text-[var(--fg-muted)] hover:text-[var(--fg)]",onClick:i,children:"Cerrar"})]}),t.warn?e.jsxs("div",{className:"px-3 py-2 rounded-lg bg-amber-50 border border-amber-300 text-amber-800 text-sm font-semibold",children:["Alerta: stock actual + pedidos (",o,") esta por debajo del punto de pedido (",r.punto_pedido??"N/D","). Revisar gestion MRP."]}):null,e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx(Q,{label:"Centro/Almacen",value:`${(s==null?void 0:s.centro)||"N/D"} / ${(s==null?void 0:s.almacen_virtual)||"N/D"}`}),e.jsx(Q,{label:"Stock de seguridad",value:r.stock_seguridad??"N/D"}),e.jsx(Q,{label:"Punto de pedido",value:r.punto_pedido??"N/D"}),e.jsx(Q,{label:"Stock maximo",value:r.stock_maximo??"N/D"}),e.jsx(Q,{label:"Stock actual (centro)",value:r.stock_actual??"N/D"}),e.jsx(Q,{label:"Pedidos en curso",value:r.pedidos_en_curso??"N/D"}),e.jsx(Q,{label:"Total stock + pedidos",value:o})]})]})}function Q({label:a,value:s}){return e.jsxs("div",{className:"p-3 rounded-lg border border-[var(--border)] bg-[var(--card)]",children:[e.jsx("p",{className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:a}),e.jsx("p",{className:"text-sm font-semibold text-[var(--fg)]",children:s})]})}function ve(a){const s=(a==null?void 0:a.mrp_detalle)||(a==null?void 0:a.mrp)||{},i=fe(a==null?void 0:a.mrp_planificado)||fe(s.planificado)||fe(s.estado)||Object.keys(s).length>0,t=Number(s.stock_actual||0),r=Number(s.pedidos_en_curso||0),o=Number(s.punto_pedido||0),u=i&&o>0&&t+r<o;return{planificado:i,warn:u,detalle:s,total:t+r}}function fa(a){return ve(a).planificado}function fe(a){if(a===!0)return!0;if(typeof a=="string"){const s=a.trim().toLowerCase();return["si","sí","true","1","planificado","yes"].includes(s)}return typeof a=="number"?a===1:!1}function ga({detalle:a}){const[s,i]=d.useState(!1);return e.jsxs("div",{className:"relative inline-block",children:[e.jsx("button",{type:"button",onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),className:"text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 cursor-help",children:e.jsx("svg",{className:"w-3.5 h-3.5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})})}),s&&e.jsxs("div",{className:"absolute z-50 left-0 top-full mt-1 w-64 p-3 rounded-lg bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 shadow-xl",children:[e.jsx("p",{className:"text-xs font-bold text-gray-700 dark:text-gray-300 mb-2",children:"Stock por Almacén"}),e.jsx("div",{className:"space-y-1.5 max-h-40 overflow-y-auto",children:a.map((t,r)=>e.jsxs("div",{className:"flex justify-between text-xs text-gray-600 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 pb-1",children:[e.jsx("span",{className:"font-medium",children:t.almacen||t.centro||"Almacén"}),e.jsxs("span",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[t.cantidad||0," un."]})]},r))}),a.length===0&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"No hay detalle de stock disponible"})]})]})}function ha(a){const s=a==null?void 0:a.detalle_stock,i=["0100","9999"];if(Array.isArray(s)&&s.length>0){const t=s.filter(r=>i.includes(String(r.almacen||r.centro||"").padStart(4,"0"))).reduce((r,o)=>r+Number(o.cantidad||0),0);return t>0?{texto:`${t} un.`,valor:t}:{texto:"Stock requiere autorización",valor:null}}return{texto:"Stock requiere autorización",valor:null}}function ie(a){return`USD ${Number(a||0).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}`}function ba({solicitud:a,items:s=[],decisiones:i={},totalItems:t=0,onBack:r,onConfirm:o,loading:u}){const x=d.useMemo(()=>Object.entries(i).map(([b,g])=>{const p=s.find(L=>Number(L.idx)===Number(b))||{},_=(g==null?void 0:g.cantidad_solicitada)??p.cantidad??0,S=_*((g==null?void 0:g.precio_unitario)||p.precio_unitario||0);return{idx:Number(b),op:g,item:p,cantidad:_,costo:S}}),[i,s]),m=x.reduce((b,g)=>b+g.costo,0),N=Math.max(...x.map(b=>{var g;return Number(((g=b.op)==null?void 0:g.plazo_dias)??0)}),0),C=Array.from(new Set(x.map(b=>{var g;return(g=b.op)==null?void 0:g.id_proveedor}).filter(Boolean)));return e.jsxs(K,{children:[e.jsxs(ae,{className:"px-5 pt-5 pb-3",children:[e.jsx(se,{children:"Revision final"}),e.jsx(oe,{className:"text-sm text-[var(--fg-muted)]",children:"Confirma antes de guardar el tratamiento"})]}),e.jsxs(W,{className:"px-5 pb-5 pt-1 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx(Z,{label:"Estado",value:e.jsx(Je,{estado:(a==null?void 0:a.estado)||(a==null?void 0:a.status)||"En progreso"})}),e.jsx(Z,{label:"Items decididos",value:`${x.length}/${t}`}),e.jsx(Z,{label:"Costo total",value:ge(m)})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx(Z,{label:"Plazo maximo",value:`${N||"N/D"} dias`}),e.jsx(Z,{label:"Proveedores",value:C.join(", ")||"N/D"}),e.jsx(Z,{label:"Centro / Sector",value:`${(a==null?void 0:a.centro)||"N/D"} / ${(a==null?void 0:a.sector)||"N/D"}`})]}),e.jsx("div",{className:"overflow-auto border border-[var(--border)] rounded-xl",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-[var(--bg-soft)] text-[var(--fg-muted)] uppercase text-xs tracking-[0.08em]",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-3 py-2",children:"Item"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Codigo"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Opcion"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Cantidad"}),e.jsx("th",{className:"text-left px-3 py-2",children:"P.U."}),e.jsx("th",{className:"text-left px-3 py-2",children:"Subtotal"}),e.jsx("th",{className:"text-left px-3 py-2",children:"Plazo"})]})}),e.jsxs("tbody",{children:[x.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-3 py-3 text-[var(--fg-muted)]",colSpan:7,children:"Sin decisiones cargadas."})}),x.map(b=>{var g,p,_,S;return e.jsxs("tr",{className:"border-t border-[var(--border)]",children:[e.jsxs("td",{className:"px-3 py-2 font-semibold text-[var(--fg)]",children:["#",b.idx+1]}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)]",children:b.item.codigo}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)]",children:((g=b.op)==null?void 0:g.nombre)||((p=b.op)==null?void 0:p.tipo)}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)]",children:b.cantidad}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)]",children:ge(((_=b.op)==null?void 0:_.precio_unitario)||0)}),e.jsx("td",{className:"px-3 py-2 text-[var(--fg)]",children:ge(b.costo)}),e.jsxs("td",{className:"px-3 py-2 text-[var(--fg)]",children:[((S=b.op)==null?void 0:S.plazo_dias)??"N/D"," d"]})]},b.idx)})]})]})}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(E,{variant:"ghost",type:"button",onClick:r,children:"Volver"}),e.jsx(E,{variant:"primary",type:"button",onClick:o,disabled:u||x.length<t,children:u?"Guardando...":"Confirmar y guardar"})]})]})]})}function Z({label:a,value:s}){return e.jsxs("div",{className:"p-3 rounded-lg border border-[var(--border)] bg-[var(--bg-soft)]",children:[e.jsx("p",{className:"text-xs uppercase font-bold tracking-[0.06em] text-[var(--fg-muted)]",children:a}),e.jsx("div",{className:"text-sm font-semibold text-[var(--fg)] mt-1",children:s})]})}function ge(a){return`USD ${Number(a||0).toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}`}const va=["Analisis","Decision","Confirmacion"];function ja({solicitud:a,isOpen:s,onClose:i,onComplete:t}){var je,Ne;const[r,o]=d.useState(1),[u,x]=d.useState(null),[m,N]=d.useState({}),[C,b]=d.useState({}),[g,p]=d.useState(0),[_,S]=d.useState(!1),[L,M]=d.useState(!1),[y,v]=d.useState(""),[A,F]=d.useState(!1),[J,I]=d.useState(!1),[O,$]=d.useState(""),[B,D]=d.useState(!1),[q,G]=d.useState(""),X=d.useMemo(()=>{const f=(u==null?void 0:u.materiales_por_criticidad)||{};return[...f.Critico||[],...f.Normal||[],...f.Bajo||[]].sort((w,k)=>((w==null?void 0:w.idx)??0)-((k==null?void 0:k.idx)??0))},[u]),h=((je=u==null?void 0:u.resumen)==null?void 0:je.total_items)||X.length||0;d.useEffect(()=>{s&&a&&(Y(),xe(),V())},[s,a]),d.useEffect(()=>{if(a!=null&&a.id&&Object.keys(C).length>0){const f=`planner_decisiones_${a.id}`;localStorage.setItem(f,JSON.stringify(C))}},[C,a==null?void 0:a.id]);const V=()=>{if(a!=null&&a.id)try{const f=`planner_decisiones_${a.id}`,z=localStorage.getItem(f);if(z){const w=JSON.parse(z);b(w)}}catch(f){console.error("Error al recuperar decisiones guardadas:",f)}},U=()=>{if(a!=null&&a.id)try{const f=`planner_decisiones_${a.id}`;localStorage.removeItem(f)}catch(f){console.error("Error al limpiar decisiones guardadas:",f)}},Y=()=>{o(1),v(""),x(null),N({}),b({}),p(0),F(!1)},xe=async()=>{var f,z,w,k;if(a!=null&&a.id){S(!0),v("");try{await ee();const P=await H.post(`/planificador/solicitudes/${a.id}/analizar`);x(((f=P.data)==null?void 0:f.data)||{})}catch(P){const l=((k=(w=(z=P.response)==null?void 0:z.data)==null?void 0:w.error)==null?void 0:k.message)||P.message||"Error desconocido";v(`Error al cargar análisis: ${l}`),console.error("Error completo en cargarAnalisis:",P)}finally{S(!1)}}},te=async f=>{var z,w,k,P;if(!(m[f]||f==null)){M(!0),v("");try{await ee();const me=((z=(await H.get(`/planificador/solicitudes/${a.id}/items/${f}/opciones-abastecimiento`)).data)==null?void 0:z.data)||{};N(Me=>({...Me,[f]:me}))}catch(l){const me=((P=(k=(w=l.response)==null?void 0:w.data)==null?void 0:k.error)==null?void 0:P.message)||l.message||"Error desconocido";v(`Error al cargar opciones de abastecimiento (Item ${f}): ${me}`),console.error("Error completo en cargarOpciones:",l)}finally{M(!1)}}},n=(f,z)=>{b(w=>({...w,[f]:z}))},c=async()=>{if(r===1){o(2),await te(0);return}if(r===2){if(Object.keys(C).length<h){v("Debes seleccionar al menos una opcion para cada item antes de continuar.");return}o(3);return}},j=async()=>{var f,z,w;if(a!=null&&a.id){if(Object.keys(C).length<h){v("Faltan decisiones por completar.");return}F(!0),v("");try{const k=Object.entries(C).map(([P,l])=>({item_idx:Number(P),decision_tipo:(l==null?void 0:l.tipo)||(l==null?void 0:l.opcion_id)||"stock",cantidad_aprobada:(l==null?void 0:l.cantidad_aprobada)??(l==null?void 0:l.cantidad_solicitada)??(l==null?void 0:l.cantidad_disponible)??(l==null?void 0:l.cantidad)??0,codigo_material:(l==null?void 0:l.codigo_material)||(l==null?void 0:l.codigo_original),id_proveedor:l==null?void 0:l.id_proveedor,precio_unitario_final:l==null?void 0:l.precio_unitario,plazo_dias:l==null?void 0:l.plazo_dias,compatibilidad_pct:l==null?void 0:l.compatibilidad_pct,observaciones:(l==null?void 0:l.observaciones)||(l==null?void 0:l.motivo_equivalencia)||"",opcion_id:l==null?void 0:l.opcion_id}));await ee(),await H.post(`/planificador/solicitudes/${a.id}/guardar-tratamiento`,{decisiones:k}),U(),t==null||t(),i==null||i()}catch(k){const P=((w=(z=(f=k.response)==null?void 0:f.data)==null?void 0:z.error)==null?void 0:w.message)||k.message||"Error al guardar el tratamiento";v(`${P}. Por favor, intente nuevamente.`),console.error("Error completo en handleGuardar:",k)}finally{F(!1)}}},R=()=>{I(!0)},T=async()=>{var f,z,w;if(!O.trim()){v("Debe ingresar un motivo de rechazo");return}v(""),F(!0);try{await ee(),await H.post(`/solicitudes/${a.id}/rechazar`,{motivo:O.trim()}),I(!1),$(""),t==null||t(),i==null||i()}catch(k){const P=((w=(z=(f=k.response)==null?void 0:f.data)==null?void 0:z.error)==null?void 0:w.message)||k.message||"Error al rechazar";v(`${P}. Por favor, intente nuevamente.`),console.error("Error en handleConfirmReject:",k)}finally{F(!1)}},De=()=>{D(!0)},Ee=async()=>{var f,z,w;if(!q.trim()){v("Debe especificar qué información necesita");return}v(""),F(!0);try{await ee(),await H.post(`/solicitudes/${a.id}/comentar`,{comentario:`[SOLICITUD DE INFORMACIÓN] ${q.trim()}`,requiere_respuesta:!0}),await H.post("/mensajes",{destinatario_id:a.id_usuario,asunto:`Solicitud de información - Solicitud #${a.id}`,mensaje:q.trim(),solicitud_id:a.id,tipo:"solicitud_informacion",metadata:{origen:"planificador",paso:"analisis_inicial"}}),D(!1),G(""),alert("Solicitud de información enviada al solicitante. El solicitante recibirá el mensaje en su bandeja de entrada.")}catch(k){const P=((w=(z=(f=k.response)==null?void 0:f.data)==null?void 0:z.error)==null?void 0:w.message)||k.message||"Error al enviar solicitud";v(`${P}. Por favor, intente nuevamente.`),console.error("Error en handleConfirmRequestInfo:",k)}finally{F(!1)}};return!s||!a?null:e.jsxs("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center px-4",children:[e.jsxs("div",{className:"w-full max-w-[2080px] max-h-[92vh] overflow-hidden rounded-2xl border border-[var(--border)] shadow-[var(--shadow-strong)] bg-[var(--card)]",children:[e.jsxs("div",{className:"relative px-6 py-4 border-b border-[var(--border)] bg-[var(--bg-soft)]",children:[e.jsx(E,{variant:"ghost",type:"button",onClick:i,className:"absolute right-4 top-4",children:"Cerrar"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs uppercase font-extrabold tracking-[0.18em] text-[var(--fg-muted)]",children:"Planificador"}),e.jsxs("h2",{className:"text-2xl font-black text-[var(--fg)]",children:["Tratar solicitud #",a.id]}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-x-3 gap-y-1 text-sm text-[var(--fg-muted)]",children:[e.jsxs("span",{children:[e.jsx("span",{className:"font-semibold text-[var(--fg)]",children:"Centro:"})," ",a.centro||"N/D"]}),e.jsx("span",{className:"text-[var(--border)]",children:"/"}),e.jsxs("span",{children:[e.jsx("span",{className:"font-semibold text-[var(--fg)]",children:"Almacén:"})," ",a.almacen_virtual||"N/D"]}),e.jsx("span",{className:"text-[var(--border)]",children:"/"}),e.jsxs("span",{children:[e.jsx("span",{className:"font-semibold text-[var(--fg)]",children:"Sector:"})," ",Na(a)]}),e.jsx("span",{className:"text-[var(--border)]",children:"/"}),e.jsxs("span",{children:[e.jsx("span",{className:"font-semibold text-[var(--fg)]",children:"Solicitante:"})," ",ya(a)]}),e.jsx("span",{className:"text-[var(--border)]",children:"/"}),e.jsxs("span",{children:[e.jsx("span",{className:"font-semibold text-[var(--fg)]",children:"Criticidad:"})," ",a.criticidad||((Ne=u==null?void 0:u.resumen)==null?void 0:Ne.criticidad)||"N/D"]})]})]})]}),e.jsx("div",{className:"px-6 py-4 border-b border-[var(--border)] flex items-center justify-center gap-4",children:va.map((f,z)=>{const w=z+1,k=r===w,P=r>w,l=P||k;return e.jsxs("button",{type:"button",onClick:()=>l&&o(w),disabled:!l,className:`flex items-center gap-2 px-3 py-2 rounded-lg transition-all ${l?"cursor-pointer hover:bg-[var(--bg-hover)]":"cursor-not-allowed opacity-50"}`,children:[e.jsx("div",{className:`w-9 h-9 rounded-full grid place-items-center font-black text-sm transition-all ${k?"bg-[var(--primary)] text-white":P?"bg-[var(--success)] text-white":"bg-[var(--bg-soft)] text-[var(--fg-muted)]"}`,children:P?e.jsx(be,{className:"w-4 h-4"}):w}),e.jsx("span",{className:`text-sm ${k?"text-[var(--fg)] font-semibold":P?"text-[var(--success)] font-medium":"text-[var(--fg-muted)]"}`,children:f})]},f)})}),y&&e.jsx("div",{className:"px-6 py-3 bg-[var(--danger-bg)] text-[var(--danger)] border-b border-[var(--danger-border)]",children:y}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[65vh]",children:_&&r===1?e.jsx(K,{children:e.jsx(W,{className:"p-6 text-center text-[var(--fg-muted)]",children:"Cargando analisis..."})}):r===1?e.jsx(ta,{analisis:u||{},solicitud:a,onNext:c,onReject:R,onRequestInfo:De}):r===2?e.jsx(da,{solicitud:a,analisis:u,items:X,totalItems:h,currentIdx:g,onChangeIdx:p,opciones:m,decisiones:C,onSelectDecision:n,onFetchOpciones:te,loadingOpciones:L,onPrev:()=>o(1),onNext:c}):e.jsx(ba,{solicitud:a,items:X,decisiones:C,totalItems:h,onBack:()=>o(2),onConfirm:j,loading:A})}),e.jsxs("div",{className:"px-6 py-4 border-t border-[var(--border)] bg-[var(--bg-soft)] flex justify-between",children:[e.jsx(E,{variant:"ghost",type:"button",onClick:()=>o(Math.max(1,r-1)),disabled:r===1||A,children:"Anterior"}),e.jsx(E,{type:"button",onClick:r===3?j:c,disabled:A||r===2&&L,children:A?"Guardando...":r===3?"Guardar tratamiento":"Siguiente"})]})]}),J&&e.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/60 px-4",children:e.jsxs("div",{className:"w-full max-w-lg bg-[var(--card)] border border-[var(--border)] shadow-[var(--shadow-strong)] rounded-2xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.18em] font-extrabold text-[var(--fg-muted)]",children:"Rechazar Solicitud"}),e.jsxs("h3",{className:"text-xl font-black text-[var(--fg)]",children:["#",a.id]})]}),e.jsx("button",{type:"button",className:"text-sm font-semibold text-[var(--fg-muted)] hover:text-[var(--fg)]",onClick:()=>{I(!1),$("")},children:"Cancelar"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:"Motivo del rechazo"}),e.jsx("textarea",{value:O,onChange:f=>$(f.target.value),rows:4,className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--accent)] focus:border-[var(--accent)] outline-none",placeholder:"Explique por qué se rechaza esta solicitud..."})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(E,{variant:"ghost",onClick:()=>{I(!1),$("")},type:"button",disabled:A,children:"Cancelar"}),e.jsx(E,{variant:"danger",onClick:T,type:"button",disabled:A,children:A?"Rechazando...":"Confirmar rechazo"})]})]})}),B&&e.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/60 px-4",children:e.jsxs("div",{className:"w-full max-w-lg bg-[var(--card)] border border-[var(--border)] shadow-[var(--shadow-strong)] rounded-2xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.18em] font-extrabold text-[var(--fg-muted)]",children:"Solicitar Información"}),e.jsxs("h3",{className:"text-xl font-black text-[var(--fg)]",children:["Solicitud #",a.id]})]}),e.jsx("button",{type:"button",className:"text-sm font-semibold text-[var(--fg-muted)] hover:text-[var(--fg)]",onClick:()=>{D(!1),G("")},children:"Cancelar"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-[var(--fg-muted)]",children:"¿Qué información necesita del solicitante?"}),e.jsx("textarea",{value:q,onChange:f=>G(f.target.value),rows:4,className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--accent)] focus:border-[var(--accent)] outline-none",placeholder:"Especifique qué información adicional requiere..."})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(E,{variant:"ghost",onClick:()=>{D(!1),G("")},type:"button",disabled:A,children:"Cancelar"}),e.jsx(E,{onClick:Ee,type:"button",disabled:A,children:A?"Enviando...":"Enviar solicitud"})]})]})})]})}function Na(a){return Qe(a)}function ya(a){const s=a.solicitante_nombre||a.nombre||"",i=a.solicitante_apellido||a.apellido||"";return`${s} ${i}`.trim()||a.id_usuario||"N/D"}const _a=300,de=20;function wa(a){const s=a.toLowerCase();return s.includes("aprobad")?{icon:e.jsx(we,{className:"w-4 h-4"}),color:"var(--success)",label:a}:s.includes("progreso")||s.includes("proceso")?{icon:e.jsx(ye,{className:"w-4 h-4"}),color:"var(--info)",label:a}:s.includes("finaliz")||s.includes("complet")||s.includes("tratad")?{icon:e.jsx(we,{className:"w-4 h-4"}),color:"var(--success)",label:a}:s.includes("rechaz")?{icon:e.jsx(Ae,{className:"w-4 h-4"}),color:"var(--danger)",label:a}:s.includes("borrador")?{icon:e.jsx(ea,{className:"w-4 h-4"}),color:"var(--warning)",label:a}:{icon:e.jsx(ye,{className:"w-4 h-4"}),color:"var(--fg-muted)",label:a}}function Ya(){var te;const{user:a}=Fe(),{t:s}=qe(),[i,t]=d.useState([]),[r,o]=d.useState(""),[u,x]=d.useState(""),[m,N]=d.useState(!1),[C,b]=d.useState(""),g=We(C,_a),[p,_]=d.useState(""),[S,L]=d.useState(""),[M,y]=d.useState(""),[v,A]=d.useState(""),[F,J]=d.useState(1),[I,O]=d.useState(null),[$,B]=d.useState({open:!1,solicitud:null,motivo:""}),D=d.useCallback(async()=>{var n,c,j,R;N(!0),o("");try{const T=await pe.listar({planner_id:((n=a==null?void 0:a.rol)==null?void 0:n.toLowerCase())==="admin"||a==null?void 0:a.id});t(Array.isArray(T.data)?T.data:[])}catch(T){o(((R=(j=(c=T.response)==null?void 0:c.data)==null?void 0:j.error)==null?void 0:R.message)||T.message)}finally{N(!1)}},[a==null?void 0:a.rol,a==null?void 0:a.id]);d.useEffect(()=>{D()},[D]),d.useEffect(()=>{J(1)},[g,p,S,M,v]);const q=d.useCallback(async n=>{var c,j,R;x(""),o("");try{await pe.aceptar(n),x(s("planner_msg_aceptar","Solicitud aceptada y marcada en progreso.")),setTimeout(()=>x(""),3e3),D()}catch(T){o(((R=(j=(c=T.response)==null?void 0:c.data)==null?void 0:j.error)==null?void 0:R.message)||T.message)}},[D,s]),G=d.useCallback(async n=>{var c,j,R;x(""),o("");try{await pe.finalizar(n),x(s("planner_msg_finalizar","Solicitud tratada/finalizada.")),setTimeout(()=>x(""),3e3),D()}catch(T){o(((R=(j=(c=T.response)==null?void 0:c.data)==null?void 0:j.error)==null?void 0:R.message)||T.message)}},[D,s]),X=d.useCallback(async()=>{var c,j,R;if(!$.solicitud)return;const n=$.motivo.trim();if(!n){o(s("planner_rechazar_motivo_required","Debes indicar el motivo del rechazo"));return}x(""),o("");try{await Oe.rechazar($.solicitud.id,n),x(s("planner_rechazar_success","Solicitud rechazada correctamente.")),setTimeout(()=>x(""),3e3),B({open:!1,solicitud:null,motivo:""}),D()}catch(T){o(((R=(j=(c=T.response)==null?void 0:c.data)==null?void 0:j.error)==null?void 0:R.message)||T.message)}},[$.solicitud,$.motivo,D,s]),h=d.useMemo(()=>{let n=[...i];if(g){const c=g.toLowerCase();n=n.filter(j=>[j.id,j.justificacion,j.centro,re(j.sector),j.status,j.estado,j.solicitante_nombre,j.solicitante_apellido].filter(Boolean).join(" ").toLowerCase().includes(c))}return p&&(n=n.filter(c=>(c.centro||"").toString().toLowerCase().includes(p.toLowerCase()))),S&&(n=n.filter(c=>re(c.sector).toLowerCase().includes(S.toLowerCase()))),M&&(n=n.filter(c=>(c.status||c.estado||"").toLowerCase().includes(M.toLowerCase()))),v&&(n=n.filter(c=>(c.criticidad||"Normal").toLowerCase()===v.toLowerCase())),n},[i,g,p,S,M,v]),V=Math.ceil(h.length/de),U=d.useMemo(()=>{const n=(F-1)*de;return h.slice(n,n+de)},[h,F]),Y=d.useCallback(()=>{const n=h.map(c=>({ID:c.id,Justificacion:c.justificacion||"",Centro:c.centro||"",Sector:re(c.sector),Criticidad:c.criticidad||"Normal","Monto Total":c.total_monto||0,Estado:c.status||c.estado||"","Fecha Necesidad":ce(c.fecha_necesidad),"Fecha Creación":ce(c.created_at),Solicitante:he(c)}));Ge(n,`planificador-${new Date().toISOString().split("T")[0]}.xls`),x(s("planner_export_success","Datos exportados correctamente")),setTimeout(()=>x(""),3e3)},[h,s]),xe=[{key:"id",header:"ID",sortAccessor:n=>Number(n.id||0)},{key:"centro",header:s("planner_centro","Centro"),sortAccessor:n=>n.centro||""},{key:"sector",header:s("planner_sector","Sector"),render:n=>re(n.sector),sortAccessor:n=>re(n.sector)},{key:"solicitante",header:s("dash_table_solicitante","Solicitante"),render:n=>he(n),sortAccessor:n=>he(n)},{key:"criticidad",header:s("planner_criticidad","Criticidad"),render:n=>{const c=n.criticidad||"Normal",j=c.toLowerCase()==="alta";return e.jsxs("span",{className:"inline-flex items-center gap-1.5",style:{color:j?"var(--danger)":"var(--fg-muted)"},children:[j&&e.jsx($e,{className:"w-4 h-4"}),c]})},sortAccessor:n=>n.criticidad||"Normal"},{key:"justificacion",header:s("planner_justificacion","Asunto"),render:n=>{const c=n.justificacion||"",j=c.length>50?c.substring(0,50)+"...":c;return e.jsx("span",{title:c,children:j})},sortAccessor:n=>(n.justificacion||"").toString()},{key:"total_monto",header:s("planner_monto","Monto"),render:n=>ne(n.total_monto||0),sortAccessor:n=>Number(n.total_monto||0)},{key:"fecha_necesidad",header:s("planner_fecha","F. Necesidad"),render:n=>ce(n.fecha_necesidad),sortAccessor:n=>new Date(n.fecha_necesidad||0).getTime()||0},{key:"created_at",header:s("planner_fecha_creacion","F. Creación"),render:n=>ce(n.created_at),sortAccessor:n=>new Date(n.created_at||0).getTime()||0},{key:"estado",header:s("planner_estado","Estado"),render:n=>{const c=n.status||n.estado||"Aprobada",j=wa(c);return e.jsxs("span",{className:"inline-flex items-center gap-1.5",style:{color:j.color},children:[j.icon,e.jsx("span",{children:j.label})]})},sortAccessor:n=>(n.status||n.estado||"").toString()},{key:"acciones",header:s("planner_acciones","Acciones"),render:n=>{const c=(n.status||n.estado||"").toLowerCase(),j=c.includes("aprobad"),R=c.includes("progreso")||c.includes("proceso");return e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",role:"group","aria-label":`${s("planner_acciones","Acciones")} solicitud ${n.id}`,children:[e.jsxs("button",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-150 bg-[var(--info)]/10 text-[var(--info)] focus:outline-none focus:ring-2 focus:ring-[var(--info)]",onClick:()=>O(n),type:"button",title:s("planner_ver","Ver detalles y tratar solicitud"),"aria-label":`${s("planner_tratar","Tratar")} solicitud ${n.id}`,children:[e.jsx(Ye,{className:"w-3.5 h-3.5","aria-hidden":"true"}),s("planner_tratar","Tratar")]}),j&&e.jsxs("button",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-150 bg-[var(--success)]/10 text-[var(--success)] focus:outline-none focus:ring-2 focus:ring-[var(--success)]",onClick:()=>q(n.id),type:"button",title:s("planner_aceptar","Aceptar"),"aria-label":`${s("planner_aceptar","Aceptar")} solicitud ${n.id}`,children:[e.jsx(Ze,{className:"w-3.5 h-3.5","aria-hidden":"true"}),s("planner_aceptar","Aceptar")]}),R&&e.jsxs("button",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-150 bg-[var(--success)]/10 text-[var(--success)] focus:outline-none focus:ring-2 focus:ring-[var(--success)]",onClick:()=>G(n.id),type:"button",title:s("planner_finalizar","Finalizar"),"aria-label":`${s("planner_finalizar","Finalizar")} solicitud ${n.id}`,children:[e.jsx(be,{className:"w-3.5 h-3.5","aria-hidden":"true"}),s("planner_finalizar","Finalizar")]}),e.jsxs("button",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-150 bg-[var(--danger)]/10 text-[var(--danger)] focus:outline-none focus:ring-2 focus:ring-[var(--danger)]",onClick:()=>B({open:!0,solicitud:n,motivo:""}),type:"button",title:s("planner_rechazar","Rechazar"),"aria-label":`${s("planner_rechazar","Rechazar")} solicitud ${n.id}`,children:[e.jsx(Ae,{className:"w-3.5 h-3.5","aria-hidden":"true"}),s("planner_rechazar","Rechazar")]})]})}}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ue,{title:"PLANIFICADOR"}),u&&e.jsx(_e,{variant:"success",onDismiss:()=>x(""),className:"animate-in fade-in duration-200",children:u}),r&&e.jsx(_e,{variant:"danger",onDismiss:()=>o(""),className:"animate-in fade-in duration-200",children:r}),e.jsxs("div",{className:"grid gap-5 xl:gap-7 lg:grid-cols-[320px,minmax(0,1fr)] items-start",children:[e.jsxs(K,{className:"sticky top-4",children:[e.jsx(ae,{className:"px-6 pt-6 pb-3",children:e.jsx(se,{children:s("planner_filters","Filtros")})}),e.jsxs(W,{className:"px-6 pb-6 pt-1 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"planner-search",className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:s("planner_busqueda_general","Búsqueda general")}),e.jsx(Ie,{id:"planner-search",value:C,onChange:n=>b(n.target.value),placeholder:s("planner_buscar_placeholder","Buscar por ID, asunto, solicitante..."),"aria-label":s("planner_busqueda_general","Búsqueda general")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"planner-centro",className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:s("planner_centro","Centro")}),e.jsxs(le,{id:"planner-centro",value:p,onChange:n=>_(n.target.value),"aria-label":s("planner_centro","Centro"),children:[e.jsx("option",{value:"",children:s("planner_todos_centros","Todos los centros")}),e.jsx("option",{value:"1008",children:"1008"}),e.jsx("option",{value:"1064",children:"1064"}),e.jsx("option",{value:"1070",children:"1070"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"planner-sector",className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:s("planner_sector","Sector")}),e.jsxs(le,{id:"planner-sector",value:S,onChange:n=>L(n.target.value),"aria-label":s("planner_sector","Sector"),children:[e.jsx("option",{value:"",children:s("planner_todos_sectores","Todos los sectores")}),e.jsx("option",{value:"Almacenes",children:s("planner_sector_almacenes","Almacenes")}),e.jsx("option",{value:"Compras",children:s("planner_sector_compras","Compras")}),e.jsx("option",{value:"Mantenimiento",children:s("planner_sector_mantenimiento","Mantenimiento")}),e.jsx("option",{value:"Planificación",children:s("planner_sector_planificacion","Planificación")}),e.jsx("option",{value:"Operaciones",children:s("planner_sector_operaciones","Operaciones")}),e.jsx("option",{value:"Logística",children:s("planner_sector_logistica","Logística")}),e.jsx("option",{value:"Producción",children:s("planner_sector_produccion","Producción")}),e.jsx("option",{value:"Calidad",children:s("planner_sector_calidad","Calidad")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"planner-estado",className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:s("planner_estado","Estado")}),e.jsxs(le,{id:"planner-estado",value:M,onChange:n=>y(n.target.value),"aria-label":s("planner_estado","Estado"),children:[e.jsx("option",{value:"",children:s("planner_todos_estados","Todos los estados")}),e.jsx("option",{value:"aprobada",children:s("planner_estado_aprobada","Aprobada")}),e.jsx("option",{value:"progreso",children:s("planner_estado_progreso","En Progreso")}),e.jsx("option",{value:"finalizada",children:s("planner_estado_finalizada","Finalizada")}),e.jsx("option",{value:"rechazada",children:s("planner_estado_rechazada","Rechazada")})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"planner-criticidad",className:"text-xs uppercase font-bold tracking-[0.08em] text-[var(--fg-muted)]",children:s("planner_criticidad","Criticidad")}),e.jsxs(le,{id:"planner-criticidad",value:v,onChange:n=>A(n.target.value),"aria-label":s("planner_criticidad","Criticidad"),children:[e.jsx("option",{value:"",children:s("planner_criticidad_todas","Todas")}),e.jsx("option",{value:"normal",children:s("planner_criticidad_normal","Normal")}),e.jsx("option",{value:"alta",children:s("planner_criticidad_alta","Alta")})]})]}),e.jsxs(E,{className:"w-full",onClick:D,disabled:m,type:"button","aria-label":m?s("planner_actualizando","Actualizando..."):s("planner_actualizar","Actualizar"),children:[e.jsx(sa,{className:`w-4 h-4 ${m?"animate-spin":""}`,"aria-hidden":"true"}),m?s("planner_actualizando","Actualizando..."):s("planner_actualizar","Actualizar")]})]})]}),e.jsxs(K,{children:[e.jsxs(ae,{className:"px-6 pt-6 pb-3 flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(se,{children:s("planner_solicitudes_asignadas","Solicitudes Asignadas")}),e.jsxs(oe,{children:[h.length," ",h.length===1?s("planner_solicitud","solicitud"):s("planner_solicitudes","solicitudes")]})]}),e.jsxs(E,{variant:"secondary",onClick:Y,type:"button",disabled:h.length===0,"aria-label":s("planner_exportar_xls","Exportar XLS"),children:[e.jsx(aa,{className:"w-4 h-4","aria-hidden":"true"}),s("planner_exportar_xls","Exportar XLS")]})]}),e.jsxs(W,{className:"px-0 pb-0 pt-0",children:[m?e.jsx(Ve,{rows:5,columns:10}):e.jsx(ze,{columns:xe,rows:U,emptyMessage:s("planner_empty_full","Sin solicitudes asignadas")}),e.jsx(Be,{currentPage:F,totalPages:V,totalItems:h.length,itemsPerPage:de,onPageChange:J,labels:{page:s("common_pagina","Página"),of:s("common_de","de"),showing:s("common_mostrando","Mostrando"),prev:s("common_anterior","Anterior"),next:s("common_siguiente","Siguiente")}})]})]})]}),e.jsx(ja,{solicitud:I,isOpen:!!I,onClose:()=>O(null),onComplete:()=>{O(null),D()}}),e.jsx(Ke,{isOpen:$.open,onClose:()=>B({open:!1,solicitud:null,motivo:""}),title:`${s("planner_rechazar_solicitud","Rechazar Solicitud")} #${(te=$.solicitud)==null?void 0:te.id}`,size:"md",footer:e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"ghost",onClick:()=>B({open:!1,solicitud:null,motivo:""}),type:"button",children:s("common_cancelar","Cancelar")}),e.jsx(E,{variant:"danger",onClick:X,type:"button",children:s("planner_confirmar_rechazo","Confirmar Rechazo")})]}),children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm text-[var(--fg-muted)]",children:[s("planner_rechazar_motivo_label","Motivo del rechazo")," ",e.jsx("span",{className:"text-[var(--danger)]",children:"*"})]}),e.jsx("textarea",{value:$.motivo,onChange:n=>B(c=>({...c,motivo:n.target.value})),rows:3,className:"w-full px-4 py-3 rounded-lg border border-[var(--border)] bg-[var(--input-bg)] text-sm text-[var(--fg)] focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] outline-none transition-all",placeholder:s("planner_rechazar_placeholder","Explica brevemente el motivo del rechazo...")})]})})]})}function he(a){const s=a.solicitante_nombre||a.nombre||"",i=a.solicitante_apellido||a.apellido||"";return`${s} ${i}`.trim()||a.id_usuario||"N/D"}export{Ya as default};
